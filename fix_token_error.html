<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokené”™è¯¯ä¿®å¤å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #a0182f;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .status-box {
            background: #f8f9fa;
            border-left: 4px solid #a0182f;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            font-weight: 600;
            color: #333;
        }
        .status-value {
            font-family: 'Courier New', monospace;
            color: #666;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .status-value.good {
            color: #4caf50;
            font-weight: bold;
        }
        .status-value.bad {
            color: #f44336;
            font-weight: bold;
        }
        button {
            background: linear-gradient(135deg, #a0182f 0%, #c41e3a 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(160, 24, 47, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(160, 24, 47, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        button.danger {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }
        .log {
            background: #263238;
            color: #aed581;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-item {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #4caf50;
            padding-left: 10px;
        }
        .log-item.error {
            border-left-color: #f44336;
            color: #ff8a80;
        }
        .log-item.warning {
            border-left-color: #ff9800;
            color: #ffd54f;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .success-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Tokené”™è¯¯ä¿®å¤å·¥å…·</h1>
        <p class="subtitle">è¯Šæ–­å¹¶ä¿®å¤ç™»å½•Tokenç›¸å…³é—®é¢˜</p>

        <div class="status-box">
            <h3>å½“å‰çŠ¶æ€</h3>
            <div class="status-item">
                <span class="status-label">TokençŠ¶æ€:</span>
                <span class="status-value" id="token-status">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç”¨æˆ·ä¿¡æ¯:</span>
                <span class="status-value" id="user-status">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç™»å½•çŠ¶æ€:</span>
                <span class="status-value" id="login-status">æ£€æŸ¥ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Tokenè¿‡æœŸæ—¶é—´:</span>
                <span class="status-value" id="token-expiry">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>

        <div id="message-box"></div>

        <button onclick="checkStatus()">ğŸ” é‡æ–°æ£€æŸ¥çŠ¶æ€</button>
        <button class="secondary" onclick="clearAndReload()">ğŸ”„ æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°</button>
        <button class="danger" onclick="clearAndLogin()">ğŸšª æ¸…é™¤ç¼“å­˜å¹¶è·³è½¬ç™»å½•</button>

        <div class="log" id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log')
            const logItem = document.createElement('div')
            logItem.className = `log-item ${type}`
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
            logContainer.appendChild(logItem)
            logContainer.scrollTop = logContainer.scrollHeight
        }

        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box')
            const className = type === 'success' ? 'success-box' : 
                            type === 'warning' ? 'warning-box' : 'info-box'
            messageBox.innerHTML = `<div class="${className}">${message}</div>`
        }

        function checkStatus() {
            log('å¼€å§‹æ£€æŸ¥TokençŠ¶æ€...')
            
            // æ£€æŸ¥Token
            const token = localStorage.getItem('token')
            const tokenStatus = document.getElementById('token-status')
            
            if (!token) {
                tokenStatus.textContent = 'âŒ æœªæ‰¾åˆ°Token'
                tokenStatus.className = 'status-value bad'
                log('æœªæ‰¾åˆ°Token', 'error')
                showMessage('âš ï¸ æ‚¨å°šæœªç™»å½•ï¼Œè¯·å…ˆç™»å½•åå†ä½¿ç”¨ç¤¾äº¤åŠŸèƒ½', 'warning')
                return
            }
            
            tokenStatus.textContent = 'âœ… Tokenå­˜åœ¨'
            tokenStatus.className = 'status-value good'
            log('Tokenå­˜åœ¨: ' + token.substring(0, 20) + '...')
            
            // æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
            const userInfoStr = localStorage.getItem('userInfo')
            const userStatus = document.getElementById('user-status')
            
            if (!userInfoStr) {
                userStatus.textContent = 'âŒ æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯'
                userStatus.className = 'status-value bad'
                log('æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯', 'error')
            } else {
                try {
                    const userInfo = JSON.parse(userInfoStr)
                    const userId = userInfo?.data?.id || userInfo?.id
                    const username = userInfo?.data?.username || userInfo?.username
                    
                    if (userId) {
                        userStatus.textContent = `âœ… ${username || 'User'} (ID: ${userId})`
                        userStatus.className = 'status-value good'
                        log(`ç”¨æˆ·ä¿¡æ¯: ${username} (ID: ${userId})`)
                    } else {
                        userStatus.textContent = 'âš ï¸ ç”¨æˆ·ä¿¡æ¯æ ¼å¼å¼‚å¸¸'
                        userStatus.className = 'status-value bad'
                        log('ç”¨æˆ·ä¿¡æ¯æ ¼å¼å¼‚å¸¸', 'warning')
                    }
                } catch (e) {
                    userStatus.textContent = 'âŒ ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥'
                    userStatus.className = 'status-value bad'
                    log('ç”¨æˆ·ä¿¡æ¯è§£æå¤±è´¥: ' + e.message, 'error')
                }
            }
            
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const loginStatus = document.getElementById('login-status')
            const isLoggedIn = !!token
            loginStatus.textContent = isLoggedIn ? 'âœ… å·²ç™»å½•' : 'âŒ æœªç™»å½•'
            loginStatus.className = isLoggedIn ? 'status-value good' : 'status-value bad'
            
            // å°è¯•è§£æJWT Token
            try {
                const parts = token.split('.')
                if (parts.length === 3) {
                    const payload = JSON.parse(atob(parts[1]))
                    const expiryDate = new Date(payload.exp * 1000)
                    const now = Date.now()
                    const isExpired = now > payload.exp * 1000
                    
                    const tokenExpiry = document.getElementById('token-expiry')
                    
                    if (isExpired) {
                        tokenExpiry.textContent = `âŒ å·²è¿‡æœŸ (${expiryDate.toLocaleString()})`
                        tokenExpiry.className = 'status-value bad'
                        log('Tokenå·²è¿‡æœŸ: ' + expiryDate.toLocaleString(), 'error')
                        showMessage('âŒ æ‚¨çš„ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•', 'warning')
                    } else {
                        const remainingTime = Math.floor((payload.exp * 1000 - now) / 1000 / 60)
                        tokenExpiry.textContent = `âœ… ${expiryDate.toLocaleString()} (å‰©ä½™${remainingTime}åˆ†é’Ÿ)`
                        tokenExpiry.className = 'status-value good'
                        log(`Tokenæœ‰æ•ˆï¼Œå‰©ä½™æ—¶é—´: ${remainingTime}åˆ†é’Ÿ`)
                        
                        if (remainingTime < 30) {
                            showMessage(`âš ï¸ Tokenå³å°†è¿‡æœŸï¼ˆå‰©ä½™${remainingTime}åˆ†é’Ÿï¼‰ï¼Œå»ºè®®é‡æ–°ç™»å½•`, 'warning')
                        } else {
                            showMessage('âœ… TokençŠ¶æ€æ­£å¸¸ï¼Œå¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·å°è¯•æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•', 'success')
                        }
                    }
                } else {
                    throw new Error('Invalid JWT format')
                }
            } catch (e) {
                const tokenExpiry = document.getElementById('token-expiry')
                tokenExpiry.textContent = 'âš ï¸ æ— æ³•è§£æToken'
                tokenExpiry.className = 'status-value bad'
                log('Tokenæ ¼å¼é”™è¯¯: ' + e.message, 'error')
                showMessage('âŒ Tokenæ ¼å¼é”™è¯¯ï¼Œè¯·æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•', 'warning')
            }
        }

        function clearAndReload() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢å—ï¼Ÿ\n\nè¿™å°†æ¸…é™¤æ‚¨çš„ç™»å½•çŠ¶æ€ï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚')) {
                log('æ¸…é™¤æ‰€æœ‰ç¼“å­˜...', 'warning')
                
                localStorage.removeItem('token')
                localStorage.removeItem('refreshToken')
                localStorage.removeItem('userInfo')
                
                log('ç¼“å­˜å·²æ¸…é™¤', 'warning')
                log('3ç§’ååˆ·æ–°é¡µé¢...', 'warning')
                
                setTimeout(() => {
                    location.reload()
                }, 3000)
            }
        }

        function clearAndLogin() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢å—ï¼Ÿ')) {
                log('æ¸…é™¤æ‰€æœ‰ç¼“å­˜...', 'warning')
                
                localStorage.removeItem('token')
                localStorage.removeItem('refreshToken')
                localStorage.removeItem('userInfo')
                
                log('ç¼“å­˜å·²æ¸…é™¤', 'warning')
                log('è·³è½¬åˆ°ç™»å½•é¡µé¢...', 'warning')
                
                setTimeout(() => {
                    window.location.href = '/login'
                }, 2000)
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            log('Tokené”™è¯¯ä¿®å¤å·¥å…·å·²å¯åŠ¨')
            checkStatus()
        }
    </script>
</body>
</html>
