<!DOCTYPE html>
<html>
<head>
    <title>诊断动态显示</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; max-width: 1200px; margin: 20px auto; padding: 20px; }
        .post { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .post-header { font-weight: bold; color: #409EFF; margin-bottom: 10px; }
        .post-content { margin: 10px 0; }
        .post-image { max-width: 300px; margin: 10px 0; border: 1px solid #eee; }
        .post-video { max-width: 400px; margin: 10px 0; }
        .error { color: red; }
        .success { color: green; }
        button { padding: 10px 20px; background: #409EFF; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
    </style>
</head>
<body>
    <h1>动态显示诊断工具</h1>
    
    <div>
        <button onclick="loadPosts()">加载最新动态</button>
        <button onclick="checkFiles()">检查文件访问</button>
        <button onclick="clearCache()">清除缓存并重新加载</button>
    </div>

    <div id="status"></div>
    <div id="posts"></div>

    <script>
        async function loadPosts() {
            document.getElementById('status').innerHTML = '<p>正在加载动态...</p>';
            
            try {
                const response = await fetch('http://localhost:8083/api/posts?page=1&size=10', {
                    cache: 'no-cache'
                });
                const result = await response.json();
                
                if (result.code === 200 && result.data) {
                    displayPosts(result.data);
                    document.getElementById('status').innerHTML = 
                        `<p class="success">✓ 成功加载 ${result.data.length} 条动态</p>`;
                } else {
                    document.getElementById('status').innerHTML = 
                        `<p class="error">✗ 加载失败: ${result.message}</p>`;
                }
            } catch (error) {
                document.getElementById('status').innerHTML = 
                    `<p class="error">✗ 请求失败: ${error.message}</p>`;
            }
        }

        function displayPosts(posts) {
            const container = document.getElementById('posts');
            container.innerHTML = '';
            
            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'post';
                
                let html = `
                    <div class="post-header">
                        动态 #${post.id} - ${post.userNickname} - ${post.createdAt}
                    </div>
                    <div class="post-content">
                        <strong>内容:</strong> ${post.content}
                    </div>
                `;
                
                // 显示图片
                if (post.images && post.images.length > 0) {
                    html += '<div><strong>图片:</strong></div>';
                    post.images.forEach((img, index) => {
                        html += `
                            <div>
                                <p>图片 ${index + 1}: <a href="${img}" target="_blank">${img}</a></p>
                                <img src="${img}" class="post-image" 
                                     onerror="this.style.border='2px solid red'; this.alt='图片加载失败: ' + this.src"
                                     onload="this.style.border='2px solid green'">
                            </div>
                        `;
                    });
                } else {
                    html += '<div><em>无图片</em></div>';
                }
                
                // 显示视频
                if (post.video) {
                    html += `
                        <div>
                            <strong>视频:</strong>
                            <p>URL: <a href="${post.video.url}" target="_blank">${post.video.url}</a></p>
                            <p>缩略图: ${post.video.thumbnail}</p>
                            <video src="${post.video.url}" controls class="post-video"
                                   onerror="this.style.border='2px solid red'"
                                   onloadeddata="this.style.border='2px solid green'">
                                您的浏览器不支持视频播放
                            </video>
                        </div>
                    `;
                } else {
                    html += '<div><em>无视频</em></div>';
                }
                
                postDiv.innerHTML = html;
                container.appendChild(postDiv);
            });
        }

        async function checkFiles() {
            document.getElementById('status').innerHTML = '<p>正在检查文件访问...</p>';
            
            const testUrls = [
                'http://localhost:8083/uploads/images/2026/01/03/1893a758-0907-48dc-a3c4-7d6c8094538d.png',
                'http://localhost:8083/uploads/videos/2026/01/03/5d08646b-583c-4333-a1a6-df27ddeb6e53.mp4'
            ];
            
            let results = '<h3>文件访问测试:</h3>';
            
            for (const url of testUrls) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    if (response.ok) {
                        results += `<p class="success">✓ ${url} - 可访问</p>`;
                    } else {
                        results += `<p class="error">✗ ${url} - HTTP ${response.status}</p>`;
                    }
                } catch (error) {
                    results += `<p class="error">✗ ${url} - ${error.message}</p>`;
                }
            }
            
            document.getElementById('status').innerHTML = results;
        }

        function clearCache() {
            // 清除缓存并重新加载
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            location.reload(true);
        }

        // 页面加载时自动加载动态
        window.onload = () => {
            loadPosts();
        };
    </script>
</body>
</html>
