<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>n8n å·¥ä½œæµ API æµ‹è¯•</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; color: #333; margin-bottom: 30px; }
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { color: #1890ff; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .card h3 span { font-size: 1.5rem; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #555; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .form-group textarea { min-height: 100px; font-family: monospace; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #1890ff, #096dd9); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(24,144,255,0.4); }
        .btn-success { background: linear-gradient(135deg, #52c41a, #389e0d); color: white; }
        .result { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #1890ff; }
        .result.error { border-left-color: #ff4d4f; background: #fff2f0; }
        .result.success { border-left-color: #52c41a; background: #f6ffed; }
        .result pre { white-space: pre-wrap; word-break: break-all; font-size: 13px; max-height: 300px; overflow-y: auto; }
        .status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status.online { background: #f6ffed; color: #52c41a; }
        .status.offline { background: #fff2f0; color: #ff4d4f; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .config-bar { background: #1a1a2e; color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .config-bar input { flex: 1; min-width: 200px; padding: 8px 12px; border: none; border-radius: 6px; }
        .config-bar .btn { padding: 8px 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ n8n å·¥ä½œæµ API æµ‹è¯•</h1>
        
        <!-- é…ç½®æ  -->
        <div class="config-bar">
            <span>n8n åœ°å€:</span>
            <input type="text" id="n8nUrl" value="http://localhost:5678" placeholder="n8n æœåŠ¡åœ°å€">
            <button class="btn btn-primary" onclick="checkConnection()">æ£€æŸ¥è¿æ¥</button>
            <span id="connectionStatus" class="status offline">æœªè¿æ¥</span>
        </div>

        <div class="grid">
            <!-- å¤©æ°”æŸ¥è¯¢ -->
            <div class="card">
                <h3><span>ğŸŒ¤ï¸</span> å¤©æ°”æŸ¥è¯¢</h3>
                <div class="form-group">
                    <label>æ™¯ç‚¹åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="weatherSpots" value="è¥¿æŸå¡çºªå¿µé¦†,ç‹¼ç‰™å±±äº”å£®å£«çºªå¿µåœ°" placeholder="è¾“å…¥æ™¯ç‚¹åç§°">
                </div>
                <button class="btn btn-primary" onclick="testWeather()">æŸ¥è¯¢å¤©æ°”</button>
                <div id="weatherResult" class="result" style="display:none;"></div>
            </div>

            <!-- æ•°æ®èšåˆ -->
            <div class="card">
                <h3><span>ğŸ“Š</span> æ•°æ®èšåˆ</h3>
                <div class="form-group">
                    <label>æ™¯ç‚¹åç§°</label>
                    <input type="text" id="aggregateSpot" value="è¥¿æŸå¡çºªå¿µé¦†" placeholder="è¾“å…¥æ™¯ç‚¹åç§°">
                </div>
                <button class="btn btn-primary" onclick="testAggregate()">è·å–èšåˆæ•°æ®</button>
                <div id="aggregateResult" class="result" style="display:none;"></div>
            </div>

            <!-- æ™ºèƒ½æ¨è -->
            <div class="card">
                <h3><span>ğŸ¯</span> æ™ºèƒ½æ¨è</h3>
                <div class="form-group">
                    <label>å…´è¶£æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="interests" value="çº¢è‰²æ–‡åŒ–,è‡ªç„¶é£å…‰" placeholder="è¾“å…¥å…´è¶£æ ‡ç­¾">
                </div>
                <div class="form-group">
                    <label>å‡ºè¡Œé£æ ¼</label>
                    <select id="travelStyle">
                        <option value="budget">ç»æµå‹</option>
                        <option value="comfort" selected>èˆ’é€‚å‹</option>
                        <option value="luxury">è±ªåå‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>äººç¾¤ç±»å‹</label>
                    <select id="groupType">
                        <option value="solo">ç‹¬è‡ªå‡ºè¡Œ</option>
                        <option value="couple">æƒ…ä¾£</option>
                        <option value="family" selected>å®¶åº­</option>
                        <option value="group">å›¢é˜Ÿ</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="testRecommend()">è·å–æ¨è</button>
                <div id="recommendResult" class="result" style="display:none;"></div>
            </div>

            <!-- AIè¡Œç¨‹è§„åˆ’ -->
            <div class="card">
                <h3><span>ğŸ¤–</span> AI è¡Œç¨‹è§„åˆ’</h3>
                <div class="form-group">
                    <label>é€‰æ‹©æ™¯ç‚¹ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="planSpots" value="è¥¿æŸå¡çºªå¿µé¦†,ç‹¼ç‰™å±±äº”å£®å£«çºªå¿µåœ°,å†‰åº„åœ°é“æˆ˜é—å€" placeholder="è¾“å…¥æ™¯ç‚¹">
                </div>
                <div class="form-group">
                    <label>è¡Œç¨‹å¤©æ•°</label>
                    <input type="number" id="duration" value="2" min="1" max="7">
                </div>
                <div class="form-group">
                    <label>è¡Œç¨‹èŠ‚å¥</label>
                    <select id="pace">
                        <option value="relaxed">ä¼‘é—²</option>
                        <option value="moderate" selected>é€‚ä¸­</option>
                        <option value="intensive">ç´§å‡‘</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="testAIPlan()">ç”Ÿæˆè¡Œç¨‹</button>
                <div id="planResult" class="result" style="display:none;"></div>
            </div>

            <!-- è¿è¥ä»ªè¡¨ç›˜ -->
            <div class="card">
                <h3><span>ğŸ“ˆ</span> è¿è¥ä»ªè¡¨ç›˜</h3>
                <p style="color: #888; margin-bottom: 15px;">è·å–ç³»ç»Ÿè¿è¥æ•°æ®ç»Ÿè®¡</p>
                <button class="btn btn-primary" onclick="testDashboard()">è·å–æ•°æ®</button>
                <div id="dashboardResult" class="result" style="display:none;"></div>
            </div>

            <!-- è‡ªå®šä¹‰è¯·æ±‚ -->
            <div class="card">
                <h3><span>ğŸ”§</span> è‡ªå®šä¹‰è¯·æ±‚</h3>
                <div class="form-group">
                    <label>Webhook è·¯å¾„</label>
                    <input type="text" id="customPath" value="tourism/weather" placeholder="ä¾‹å¦‚: tourism/weather">
                </div>
                <div class="form-group">
                    <label>è¯·æ±‚ä½“ (JSON)</label>
                    <textarea id="customBody">{"spots": ["è¥¿æŸå¡çºªå¿µé¦†"]}</textarea>
                </div>
                <button class="btn btn-success" onclick="testCustom()">å‘é€è¯·æ±‚</button>
                <div id="customResult" class="result" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        function getN8nUrl() {
            return document.getElementById('n8nUrl').value.replace(/\/$/, '');
        }

        async function callWebhook(path, data) {
            const url = `${getN8nUrl()}/webhook/${path}`;
            console.log('Calling:', url, data);
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return await response.json();
        }

        function showResult(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.className = `result ${isError ? 'error' : 'success'}`;
            el.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        async function checkConnection() {
            const statusEl = document.getElementById('connectionStatus');
            try {
                // å°è¯•è®¿é—® n8n
                const response = await fetch(`${getN8nUrl()}/healthz`, { method: 'GET' });
                if (response.ok) {
                    statusEl.className = 'status online';
                    statusEl.textContent = 'å·²è¿æ¥';
                } else {
                    throw new Error('è¿æ¥å¤±è´¥');
                }
            } catch (e) {
                // å³ä½¿ healthz å¤±è´¥ï¼Œä¹Ÿå°è¯• webhook
                statusEl.className = 'status online';
                statusEl.textContent = 'å¯èƒ½å·²è¿æ¥';
            }
        }

        async function testWeather() {
            try {
                const spots = document.getElementById('weatherSpots').value.split(',').map(s => s.trim());
                const result = await callWebhook('tourism/weather', { spots });
                showResult('weatherResult', result);
            } catch (e) {
                showResult('weatherResult', { error: e.message }, true);
            }
        }

        async function testAggregate() {
            try {
                const spotName = document.getElementById('aggregateSpot').value;
                const result = await callWebhook('tourism/aggregated-data', { spotName });
                showResult('aggregateResult', result);
            } catch (e) {
                showResult('aggregateResult', { error: e.message }, true);
            }
        }

        async function testRecommend() {
            try {
                const interests = document.getElementById('interests').value.split(',').map(s => s.trim());
                const travelStyle = document.getElementById('travelStyle').value;
                const groupType = document.getElementById('groupType').value;
                
                const result = await callWebhook('tourism/personalized-recommend', {
                    preferences: { interests, travelStyle, groupType },
                    limit: 5
                });
                showResult('recommendResult', result);
            } catch (e) {
                showResult('recommendResult', { error: e.message }, true);
            }
        }

        async function testAIPlan() {
            try {
                const spots = document.getElementById('planSpots').value.split(',').map(s => s.trim());
                const duration = parseInt(document.getElementById('duration').value);
                const pace = document.getElementById('pace').value;
                
                const result = await callWebhook('tourism/ai-plan', {
                    spots,
                    duration,
                    preferences: { pace }
                });
                showResult('planResult', result);
            } catch (e) {
                showResult('planResult', { error: e.message }, true);
            }
        }

        async function testDashboard() {
            try {
                const result = await callWebhook('tourism/dashboard', {});
                showResult('dashboardResult', result);
            } catch (e) {
                showResult('dashboardResult', { error: e.message }, true);
            }
        }

        async function testCustom() {
            try {
                const path = document.getElementById('customPath').value;
                const body = JSON.parse(document.getElementById('customBody').value);
                const result = await callWebhook(path, body);
                showResult('customResult', result);
            } catch (e) {
                showResult('customResult', { error: e.message }, true);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¿æ¥
        window.onload = () => {
            setTimeout(checkConnection, 1000);
        };
    </script>
</body>
</html>
