{
  "name": "æ™ºæ…§æ—…æ¸¸ - å¤©æ°”æŸ¥è¯¢+AIå‡ºè¡Œå»ºè®®",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "tourism/weather",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              { "name": "Access-Control-Allow-Origin", "value": "*" }
            ]
          }
        }
      },
      "id": "webhook-weather",
      "name": "Webhook å¤©æ°”æŸ¥è¯¢",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nconst spots = body.spots || ['è¥¿æŸå¡çºªå¿µé¦†'];\nconst date = body.date || new Date().toISOString().split('T')[0];\n\nconst spotCityMap = {\n  'è¥¿æŸå¡çºªå¿µé¦†': 'Shijiazhuang',\n  'ç‹¼ç‰™å±±äº”å£®å£«çºªå¿µåœ°': 'Baoding',\n  'å†‰åº„åœ°é“æˆ˜é—å€': 'Baoding',\n  'æå¤§é’Šçºªå¿µé¦†': 'Tangshan',\n  'ç™½æ´‹æ·€é›ç¿é˜Ÿçºªå¿µé¦†': 'Baoding',\n  'å¡ç½•åå±•è§ˆé¦†': 'Chengde',\n  'å…«è·¯å†›ä¸€äºŒä¹å¸ˆå¸ä»¤éƒ¨': 'Handan',\n  'çŸ³å®¶åº„è§£æ”¾çºªå¿µé¦†': 'Shijiazhuang'\n};\n\nconst firstSpot = spots[0];\nconst city = spotCityMap[firstSpot] || 'Shijiazhuang';\n\nreturn { spots, city, date, spotCityMap };"
      },
      "id": "prepare-request",
      "name": "å‡†å¤‡è¯·æ±‚å‚æ•°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "=https://api.worldweatheronline.com/premium/v1/weather.ashx",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            { "name": "key", "value": "8361c49d6dcd417c855134458261001" },
            { "name": "q", "value": "={{ $json.city }}" },
            { "name": "format", "value": "json" },
            { "name": "num_of_days", "value": "3" },
            { "name": "lang", "value": "zh" }
          ]
        },
        "options": {}
      },
      "id": "weather-api",
      "name": "è°ƒç”¨å¤©æ°”API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [700, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const prepareData = $('å‡†å¤‡è¯·æ±‚å‚æ•°').first().json;\nconst apiResponse = $input.first().json;\nconst spots = prepareData.spots;\nconst spotCityMap = prepareData.spotCityMap;\n\nconst weatherList = [];\nlet weatherSummary = '';\n\nif (apiResponse.data && apiResponse.data.current_condition) {\n  const current = apiResponse.data.current_condition[0];\n  const forecast = apiResponse.data.weather || [];\n  \n  for (const spot of spots) {\n    const todayForecast = forecast[0] || {};\n    let condition = 'æ™´';\n    if (current.lang_zh && current.lang_zh[0]) {\n      condition = current.lang_zh[0].value;\n    } else if (current.weatherDesc && current.weatherDesc[0]) {\n      condition = current.weatherDesc[0].value;\n    }\n    \n    const weatherData = {\n      spotName: spot,\n      city: spotCityMap[spot] || 'çŸ³å®¶åº„',\n      date: todayForecast.date || new Date().toISOString().split('T')[0],\n      condition: condition,\n      temperature: {\n        current: parseInt(current.temp_C) || 10,\n        min: parseInt(todayForecast.mintempC) || 5,\n        max: parseInt(todayForecast.maxtempC) || 15\n      },\n      humidity: parseInt(current.humidity) || 50,\n      windSpeed: parseInt(current.windspeedKmph) || 10,\n      feelsLike: parseInt(current.FeelsLikeC) || 10,\n      uvIndex: parseInt(current.uvIndex) || 3\n    };\n    weatherList.push(weatherData);\n  }\n  \n  // ç”Ÿæˆå¤©æ°”æ‘˜è¦ä¾›AIä½¿ç”¨\n  const w = weatherList[0];\n  weatherSummary = `æ™¯ç‚¹ï¼š${spots.join('ã€')}\\næ—¥æœŸï¼š${w.date}\\nå¤©æ°”ï¼š${w.condition}\\næ¸©åº¦ï¼š${w.temperature.min}Â°C ~ ${w.temperature.max}Â°C\\nä½“æ„Ÿæ¸©åº¦ï¼š${w.feelsLike}Â°C\\næ¹¿åº¦ï¼š${w.humidity}%\\né£é€Ÿï¼š${w.windSpeed}km/h\\nç´«å¤–çº¿æŒ‡æ•°ï¼š${w.uvIndex}`;\n} else {\n  // æ¨¡æ‹Ÿæ•°æ®\n  for (const spot of spots) {\n    const conditions = ['æ™´', 'å¤šäº‘', 'é˜´'];\n    const condition = conditions[Math.floor(Math.random() * conditions.length)];\n    const maxTemp = Math.floor(Math.random() * 15) + 5;\n    weatherList.push({\n      spotName: spot,\n      city: spotCityMap[spot] || 'çŸ³å®¶åº„',\n      date: new Date().toISOString().split('T')[0],\n      condition: condition,\n      temperature: { current: maxTemp - 3, min: maxTemp - 8, max: maxTemp },\n      humidity: Math.floor(Math.random() * 30) + 40,\n      windSpeed: Math.floor(Math.random() * 15) + 5,\n      dataSource: 'mock'\n    });\n  }\n  const w = weatherList[0];\n  weatherSummary = `æ™¯ç‚¹ï¼š${spots.join('ã€')}\\næ—¥æœŸï¼š${w.date}\\nå¤©æ°”ï¼š${w.condition}\\næ¸©åº¦ï¼š${w.temperature.min}Â°C ~ ${w.temperature.max}Â°C\\næ¹¿åº¦ï¼š${w.humidity}%`;\n}\n\nreturn { weatherList, weatherSummary, spots };"
      },
      "id": "process-weather",
      "name": "å¤„ç†å¤©æ°”æ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [950, 300]
    },
    {
      "parameters": {
        "model": "gpt-3.5-turbo",
        "messages": {
          "values": [
            {
              "role": "system",
              "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ²³åŒ—çº¢è‰²æ—…æ¸¸å‡ºè¡Œé¡¾é—®ã€‚æ ¹æ®å¤©æ°”æƒ…å†µï¼Œä¸ºæ¸¸å®¢æä¾›ç®€æ´å®ç”¨çš„å‡ºè¡Œå»ºè®®ã€‚å›å¤è¦æ±‚ï¼š\n1. ç®€æ´æ˜äº†ï¼Œä¸è¶…è¿‡150å­—\n2. åŒ…å«ç©¿è¡£å»ºè®®ã€å‡ºè¡Œæ—¶é—´å»ºè®®ã€æ³¨æ„äº‹é¡¹\n3. é’ˆå¯¹çº¢è‰²æ™¯ç‚¹ç‰¹ç‚¹ç»™å‡ºå»ºè®®\n4. ä½¿ç”¨emojiè®©å»ºè®®æ›´ç”ŸåŠ¨"
            },
            {
              "role": "user",
              "content": "=è¯·æ ¹æ®ä»¥ä¸‹å¤©æ°”ä¿¡æ¯ï¼Œç»™å‡ºå‡ºè¡Œå»ºè®®ï¼š\n\n{{ $json.weatherSummary }}"
            }
          ]
        },
        "options": {
          "temperature": 0.7,
          "maxTokens": 300
        }
      },
      "id": "ai-suggestion",
      "name": "AIç”Ÿæˆå‡ºè¡Œå»ºè®®",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1,
      "position": [1200, 300],
      "credentials": {
        "openAiApi": {
          "id": "openai-credentials",
          "name": "OpenAI API"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const weatherData = $('å¤„ç†å¤©æ°”æ•°æ®').first().json;\nconst aiResponse = $input.first().json;\n\nlet aiSuggestion = '';\n\n// å°è¯•è·å–AIå»ºè®®\nif (aiResponse && aiResponse.message && aiResponse.message.content) {\n  aiSuggestion = aiResponse.message.content;\n} else if (aiResponse && aiResponse.text) {\n  aiSuggestion = aiResponse.text;\n} else {\n  // AIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨è§„åˆ™ç”Ÿæˆå»ºè®®\n  const w = weatherData.weatherList[0];\n  const condition = w.condition;\n  const maxTemp = w.temperature.max;\n  const minTemp = w.temperature.min;\n  \n  let suggestion = '';\n  \n  if (condition.includes('é›¨')) {\n    suggestion = `â˜” ä»Šæ—¥æœ‰é›¨ï¼Œå»ºè®®æºå¸¦é›¨å…·ã€‚\\nğŸ‘” ç©¿ç€é˜²æ°´å¤–å¥—å’Œé˜²æ»‘é‹ã€‚\\nâ° å»ºè®®é€‰æ‹©å®¤å†…å±•é¦†å‚è§‚ã€‚\\nğŸ“¸ é›¨ä¸­æ™¯è‰²åˆ«æœ‰éŸµå‘³ï¼Œå¯æ‹æ‘„ç‰¹è‰²ç…§ç‰‡ã€‚`;\n  } else if (condition.includes('é›ª')) {\n    suggestion = `â„ï¸ ä»Šæ—¥æœ‰é›ªï¼Œé“è·¯å¯èƒ½æ¹¿æ»‘ã€‚\\nğŸ§¥ æ³¨æ„ä¿æš–ï¼Œç©¿åšå¤–å¥—å’Œé˜²æ»‘é‹ã€‚\\nâ° å»ºè®®ä¸Šåˆ10ç‚¹åå‡ºè¡Œã€‚\\nâš ï¸ å±±åŒºæ™¯ç‚¹è°¨æ…å‰å¾€ã€‚`;\n  } else if (maxTemp > 30) {\n    suggestion = `ğŸŒ¡ï¸ ä»Šæ—¥æ°”æ¸©è¾ƒé«˜(${maxTemp}Â°C)ã€‚\\nğŸ‘• ç©¿ç€è½»è–„é€æ°”è¡£ç‰©ã€‚\\nğŸ’§ å¤šè¡¥å……æ°´åˆ†ï¼Œæ³¨æ„é˜²æš‘ã€‚\\nâ° å»ºè®®æ—©æ™šå‡ºè¡Œï¼Œé¿å¼€æ­£åˆã€‚`;\n  } else if (minTemp < 5) {\n    suggestion = `ğŸ§£ ä»Šæ—¥æ°”æ¸©è¾ƒä½(${minTemp}~${maxTemp}Â°C)ã€‚\\nğŸ§¥ ç©¿ç€ä¿æš–å¤–å¥—ï¼Œæˆ´å¸½å­æ‰‹å¥—ã€‚\\nâ˜• å¯æºå¸¦ä¿æ¸©æ¯ã€‚\\nâ° å»ºè®®ä¸­åˆå‰åå‡ºè¡Œã€‚`;\n  } else if (condition.includes('æ™´')) {\n    suggestion = `â˜€ï¸ ä»Šæ—¥å¤©æ°”æ™´å¥½ï¼Œéå¸¸é€‚åˆå‡ºè¡Œï¼\\nğŸ‘” ç©¿ç€èˆ’é€‚ï¼Œå¯å¸¦è–„å¤–å¥—ã€‚\\nğŸ•¶ï¸ å»ºè®®æºå¸¦å¤ªé˜³é•œå’Œé˜²æ™’ç”¨å“ã€‚\\nğŸ“¸ å…‰çº¿å……è¶³ï¼Œé€‚åˆæ‹ç…§ç•™å¿µã€‚`;\n  } else {\n    suggestion = `ğŸŒ¤ï¸ ä»Šæ—¥å¤©æ°”é€‚å®œå‡ºè¡Œã€‚\\nğŸ‘” å»ºè®®ç©¿ç€èˆ’é€‚çš„ä¼‘é—²è£…ã€‚\\nğŸ’ æºå¸¦å°‘é‡é¥®æ°´å’Œé›¶é£Ÿã€‚\\nğŸ“± æå‰æŸ¥çœ‹æ™¯ç‚¹å¼€æ”¾æ—¶é—´ã€‚`;\n  }\n  \n  aiSuggestion = suggestion;\n}\n\n// ä¸ºæ¯ä¸ªæ™¯ç‚¹æ·»åŠ å»ºè®®\nconst weatherWithSuggestion = weatherData.weatherList.map(w => ({\n  ...w,\n  suggestion: aiSuggestion\n}));\n\nreturn {\n  success: true,\n  queryTime: new Date().toISOString(),\n  weather: weatherWithSuggestion,\n  aiSuggestion: aiSuggestion,\n  spots: weatherData.spots\n};"
      },
      "id": "format-response",
      "name": "æ ¼å¼åŒ–æœ€ç»ˆå“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "respond",
      "name": "è¿”å›å“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1700, 300]
    }
  ],
  "connections": {
    "Webhook å¤©æ°”æŸ¥è¯¢": {
      "main": [[{ "node": "å‡†å¤‡è¯·æ±‚å‚æ•°", "type": "main", "index": 0 }]]
    },
    "å‡†å¤‡è¯·æ±‚å‚æ•°": {
      "main": [[{ "node": "è°ƒç”¨å¤©æ°”API", "type": "main", "index": 0 }]]
    },
    "è°ƒç”¨å¤©æ°”API": {
      "main": [[{ "node": "å¤„ç†å¤©æ°”æ•°æ®", "type": "main", "index": 0 }]]
    },
    "å¤„ç†å¤©æ°”æ•°æ®": {
      "main": [[{ "node": "AIç”Ÿæˆå‡ºè¡Œå»ºè®®", "type": "main", "index": 0 }]]
    },
    "AIç”Ÿæˆå‡ºè¡Œå»ºè®®": {
      "main": [[{ "node": "æ ¼å¼åŒ–æœ€ç»ˆå“åº”", "type": "main", "index": 0 }]]
    },
    "æ ¼å¼åŒ–æœ€ç»ˆå“åº”": {
      "main": [[{ "node": "è¿”å›å“åº”", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
