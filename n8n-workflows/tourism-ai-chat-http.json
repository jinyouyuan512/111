{
  "name": "æ™ºæ…§æ—…æ¸¸-AIèŠå¤©(å†€å°æ¸¸)-HTTPç‰ˆ",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "tourism/ai-chat",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-001",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, name, description, address, ticket_price, opening_hours, category FROM attraction WHERE status = 'open' ORDER BY rating DESC LIMIT 10",
        "options": {}
      },
      "id": "mysql-001",
      "name": "MySQLè·å–æ™¯ç‚¹",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.3,
      "position": [450, 300],
      "credentials": {
        "mySql": {
          "id": "YOUR_MYSQL_CREDENTIAL_ID",
          "name": "MySQL jiyi_tourism"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const spots = $input.all();\nconst webhookData = $('Webhook').first().json.body || {};\nconst question = webhookData.question || 'ä½ å¥½';\n\n// æ„å»ºæ™¯ç‚¹ä¿¡æ¯\nlet spotInfo = spots.map(s => {\n  const d = s.json;\n  return `ã€${d.name}ã€‘${d.description || ''} åœ°å€ï¼š${d.address || ''} é—¨ç¥¨ï¼š${d.ticket_price > 0 ? d.ticket_price + 'å…ƒ' : 'å…è´¹'} å¼€æ”¾æ—¶é—´ï¼š${d.opening_hours || ''}`;\n}).join('\\n');\n\nif (!spotInfo) {\n  spotInfo = 'ã€è¥¿æŸå¡çºªå¿µé¦†ã€‘æ–°ä¸­å›½ä»è¿™é‡Œèµ°æ¥ åœ°å€ï¼šçŸ³å®¶åº„å¸‚å¹³å±±å¿ é—¨ç¥¨ï¼šå…è´¹ å¼€æ”¾æ—¶é—´ï¼š9:00-17:00\\nã€ç‹¼ç‰™å±±äº”å£®å£«çºªå¿µåœ°ã€‘è‹±é›„å£®ä¸¾ï¼Œæ°”å£®å±±æ²³ åœ°å€ï¼šä¿å®šå¸‚æ˜“å¿ é—¨ç¥¨ï¼š65å…ƒ';\n}\n\nconst systemPrompt = `ä½ æ˜¯å†€å°æ¸¸ï¼Œæ²³åŒ—çº¢è‰²æ—…æ¸¸æ™ºèƒ½åŠ©æ‰‹ã€‚ä½ çƒ­æƒ…å‹å¥½ï¼Œå¯¹æ²³åŒ—çš„çº¢è‰²æ™¯ç‚¹éå¸¸äº†è§£ã€‚\n\nä½ å¯ä»¥å¸®åŠ©æ¸¸å®¢ï¼š\n1. ä»‹ç»çº¢è‰²æ™¯ç‚¹çš„å†å²å’Œç‰¹è‰²\n2. æ¨èæ—…æ¸¸è·¯çº¿\n3. æä¾›å‘¨è¾¹ç¾é£Ÿæ¨è\n4. è§£ç­”é—¨ç¥¨ã€å¼€æ”¾æ—¶é—´ç­‰é—®é¢˜\n\nä»¥ä¸‹æ˜¯æ²³åŒ—ä¸»è¦çº¢è‰²æ™¯ç‚¹ä¿¡æ¯ï¼š\n${spotInfo}\n\nå›ç­”è¦ç®€æ´å‹å¥½ï¼Œä½¿ç”¨emojiå¢åŠ äº²å’ŒåŠ›ã€‚å¦‚æœé—®é¢˜ä¸æ²³åŒ—çº¢è‰²æ—…æ¸¸æ— å…³ï¼Œç¤¼è²Œåœ°å¼•å¯¼ç”¨æˆ·è¯¢é—®ç›¸å…³é—®é¢˜ã€‚`;\n\nreturn [{\n  json: {\n    systemPrompt,\n    question,\n    sessionId: webhookData.sessionId || 'default'\n  }\n}];"
      },
      "id": "code-prepare",
      "name": "å‡†å¤‡æç¤ºè¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gpt-3.5-turbo\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": {{ JSON.stringify($json.systemPrompt) }}},\n    {\"role\": \"user\", \"content\": {{ JSON.stringify($json.question) }}}\n  ],\n  \"temperature\": 0.7,\n  \"max_tokens\": 1000\n}",
        "options": {}
      },
      "id": "http-openai",
      "name": "è°ƒç”¨OpenAI",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_OPENAI_HEADER_AUTH_ID",
          "name": "OpenAI API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $('å‡†å¤‡æç¤ºè¯').first().json;\nconst openaiResponse = $input.first().json;\n\nlet answer = '';\nlet type = 'general';\n\ntry {\n  answer = openaiResponse.choices?.[0]?.message?.content || '';\n  \n  // åˆ¤æ–­å›ç­”ç±»å‹\n  const ql = (input.question || '').toLowerCase();\n  if (ql.includes('è¥¿æŸå¡') || ql.includes('ç‹¼ç‰™å±±') || ql.includes('ç™½æ´‹æ·€') || ql.includes('æ™¯ç‚¹')) {\n    type = 'spot_info';\n  } else if (ql.includes('è·¯çº¿') || ql.includes('æ¨è') || ql.includes('è¡Œç¨‹')) {\n    type = 'route';\n  } else if (ql.includes('ç¾é£Ÿ') || ql.includes('åƒ') || ql.includes('é¤')) {\n    type = 'food';\n  } else if (ql.includes('å¤©æ°”') || ql.includes('ç©¿')) {\n    type = 'weather';\n  }\n} catch (e) {\n  answer = 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚æ‚¨å¯ä»¥é—®æˆ‘å…³äºæ²³åŒ—çº¢è‰²æ™¯ç‚¹ã€æ—…æ¸¸è·¯çº¿æˆ–å‘¨è¾¹ç¾é£Ÿçš„é—®é¢˜ã€‚';\n}\n\nif (!answer) {\n  answer = 'ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯å†€å°æ¸¸ï¼Œæ²³åŒ—çº¢è‰²æ—…æ¸¸æ™ºèƒ½åŠ©æ‰‹ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ';\n}\n\nreturn [{\n  json: {\n    answer: answer,\n    type: type,\n    sessionId: input.sessionId || 'default',\n    suggestions: ['è¥¿æŸå¡æœ‰ä»€ä¹ˆå¿…çœ‹æ™¯ç‚¹ï¼Ÿ', 'æ¨èä¸€æ—¥æ¸¸è·¯çº¿', 'é™„è¿‘æœ‰ä»€ä¹ˆç¾é£Ÿï¼Ÿ'],\n    timestamp: new Date().toISOString(),\n    generatedBy: 'OpenAI'\n  }\n}];"
      },
      "id": "code-format",
      "name": "æ ¼å¼åŒ–ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "respond-001",
      "name": "å“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1250, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "MySQLè·å–æ™¯ç‚¹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MySQLè·å–æ™¯ç‚¹": {
      "main": [
        [
          {
            "node": "å‡†å¤‡æç¤ºè¯",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡æç¤ºè¯": {
      "main": [
        [
          {
            "node": "è°ƒç”¨OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è°ƒç”¨OpenAI": {
      "main": [
        [
          {
            "node": "æ ¼å¼åŒ–ç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ ¼å¼åŒ–ç»“æœ": {
      "main": [
        [
          {
            "node": "å“åº”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1",
  "meta": {
    "instanceId": "local"
  }
}
