{
  "name": "æ™ºæ…§æ—…æ¸¸ - å¤©æ°”æŸ¥è¯¢(çœŸå®API)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "tourism/weather",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              { "name": "Access-Control-Allow-Origin", "value": "*" }
            ]
          }
        }
      },
      "id": "webhook-weather",
      "name": "Webhook å¤©æ°”æŸ¥è¯¢",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "jsCode": "// è·å–è¯·æ±‚å‚æ•°\nconst body = $input.first().json.body || $input.first().json;\nconst spots = body.spots || ['è¥¿æŸå¡çºªå¿µé¦†'];\nconst date = body.date || new Date().toISOString().split('T')[0];\n\n// æ™¯ç‚¹å¯¹åº”çš„åŸå¸‚ï¼ˆè‹±æ–‡ï¼Œç”¨äºAPIæŸ¥è¯¢ï¼‰\nconst spotCityMap = {\n  'è¥¿æŸå¡çºªå¿µé¦†': 'Shijiazhuang',\n  'ç‹¼ç‰™å±±äº”å£®å£«çºªå¿µåœ°': 'Baoding',\n  'å†‰åº„åœ°é“æˆ˜é—å€': 'Baoding',\n  'æå¤§é’Šçºªå¿µé¦†': 'Tangshan',\n  'ç™½æ´‹æ·€é›ç¿é˜Ÿçºªå¿µé¦†': 'Baoding',\n  'å¡ç½•åå±•è§ˆé¦†': 'Chengde',\n  'å…«è·¯å†›ä¸€äºŒä¹å¸ˆå¸ä»¤éƒ¨': 'Handan',\n  'çŸ³å®¶åº„è§£æ”¾çºªå¿µé¦†': 'Shijiazhuang'\n};\n\n// è¿”å›ç¬¬ä¸€ä¸ªæ™¯ç‚¹çš„åŸå¸‚ç”¨äºAPIæŸ¥è¯¢\nconst firstSpot = spots[0];\nconst city = spotCityMap[firstSpot] || 'Shijiazhuang';\n\nreturn {\n  spots,\n  city,\n  date,\n  spotCityMap\n};"
      },
      "id": "prepare-request",
      "name": "å‡†å¤‡è¯·æ±‚å‚æ•°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "=https://api.worldweatheronline.com/premium/v1/weather.ashx",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            { "name": "key", "value": "8361c49d6dcd417c855134458261001" },
            { "name": "q", "value": "={{ $json.city }}" },
            { "name": "format", "value": "json" },
            { "name": "num_of_days", "value": "3" },
            { "name": "lang", "value": "zh" }
          ]
        },
        "options": {}
      },
      "id": "weather-api",
      "name": "è°ƒç”¨å¤©æ°”API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [700, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// è·å–å‰é¢èŠ‚ç‚¹çš„æ•°æ®\nconst prepareData = $('å‡†å¤‡è¯·æ±‚å‚æ•°').first().json;\nconst apiResponse = $input.first().json;\nconst spots = prepareData.spots;\nconst spotCityMap = prepareData.spotCityMap;\n\nconst weather = [];\n\n// æ£€æŸ¥APIæ˜¯å¦è¿”å›æˆåŠŸ\nif (apiResponse.data && apiResponse.data.current_condition) {\n  const current = apiResponse.data.current_condition[0];\n  const forecast = apiResponse.data.weather || [];\n  \n  for (const spot of spots) {\n    const todayForecast = forecast[0] || {};\n    \n    // è·å–ä¸­æ–‡å¤©æ°”æè¿°\n    let condition = 'æ™´';\n    if (current.lang_zh && current.lang_zh[0]) {\n      condition = current.lang_zh[0].value;\n    } else if (current.weatherDesc && current.weatherDesc[0]) {\n      condition = current.weatherDesc[0].value;\n    }\n    \n    weather.push({\n      spotName: spot,\n      city: spotCityMap[spot] || 'çŸ³å®¶åº„',\n      date: todayForecast.date || new Date().toISOString().split('T')[0],\n      condition: condition,\n      temperature: {\n        current: parseInt(current.temp_C) || 10,\n        min: parseInt(todayForecast.mintempC) || 5,\n        max: parseInt(todayForecast.maxtempC) || 15\n      },\n      humidity: parseInt(current.humidity) || 50,\n      windSpeed: parseInt(current.windspeedKmph) || 10,\n      feelsLike: parseInt(current.FeelsLikeC) || 10,\n      uvIndex: parseInt(current.uvIndex) || 3,\n      suggestion: getSuggestion(condition, parseInt(todayForecast.maxtempC) || 15)\n    });\n  }\n} else {\n  // APIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®\n  for (const spot of spots) {\n    const conditions = ['æ™´', 'å¤šäº‘', 'é˜´'];\n    const condition = conditions[Math.floor(Math.random() * conditions.length)];\n    const maxTemp = Math.floor(Math.random() * 15) + 5;\n    \n    weather.push({\n      spotName: spot,\n      city: spotCityMap[spot] || 'çŸ³å®¶åº„',\n      date: new Date().toISOString().split('T')[0],\n      condition: condition,\n      temperature: {\n        current: maxTemp - 3,\n        min: maxTemp - 8,\n        max: maxTemp\n      },\n      humidity: Math.floor(Math.random() * 30) + 40,\n      windSpeed: Math.floor(Math.random() * 15) + 5,\n      suggestion: getSuggestion(condition, maxTemp),\n      dataSource: 'mock'\n    });\n  }\n}\n\nfunction getSuggestion(condition, maxTemp) {\n  if (condition.includes('é›¨') || condition.includes('Rain')) return 'â˜” å»ºè®®æºå¸¦é›¨å…·ï¼Œæ³¨æ„é˜²æ»‘';\n  if (condition.includes('é›ª') || condition.includes('Snow')) return 'â„ï¸ é“è·¯å¯èƒ½æ¹¿æ»‘ï¼Œæ³¨æ„ä¿æš–å’Œå®‰å…¨';\n  if (maxTemp > 30) return 'ğŸŒ¡ï¸ å¤©æ°”ç‚çƒ­ï¼Œæ³¨æ„é˜²æš‘é™æ¸©';\n  if (maxTemp < 5) return 'ğŸ§¥ å¤©æ°”å¯’å†·ï¼Œæ³¨æ„ä¿æš–';\n  if (condition.includes('æ™´') || condition.includes('Sunny')) return 'â˜€ï¸ å¤©æ°”æ™´å¥½ï¼Œé€‚åˆå‡ºè¡Œ';\n  return 'ğŸŒ¤ï¸ å¤©æ°”é€‚å®œå‡ºè¡Œï¼Œç¥æ—…é€”æ„‰å¿«';\n}\n\nreturn {\n  success: true,\n  queryTime: new Date().toISOString(),\n  weather\n};"
      },
      "id": "format-response",
      "name": "æ ¼å¼åŒ–å“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [950, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "respond",
      "name": "è¿”å›å“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1200, 300]
    }
  ],
  "connections": {
    "Webhook å¤©æ°”æŸ¥è¯¢": {
      "main": [[{ "node": "å‡†å¤‡è¯·æ±‚å‚æ•°", "type": "main", "index": 0 }]]
    },
    "å‡†å¤‡è¯·æ±‚å‚æ•°": {
      "main": [[{ "node": "è°ƒç”¨å¤©æ°”API", "type": "main", "index": 0 }]]
    },
    "è°ƒç”¨å¤©æ°”API": {
      "main": [[{ "node": "æ ¼å¼åŒ–å“åº”", "type": "main", "index": 0 }]]
    },
    "æ ¼å¼åŒ–å“åº”": {
      "main": [[{ "node": "è¿”å›å“åº”", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
