{
  "name": "æ™ºæ…§æ—…æ¸¸ - AIæ™ºèƒ½é—®ç­”åŠ©æ‰‹",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "tourism/ai-chat",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              { "name": "Access-Control-Allow-Origin", "value": "*" }
            ]
          }
        }
      },
      "id": "webhook-chat",
      "name": "Webhook é—®ç­”è¯·æ±‚",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡\nconst body = $input.first().json.body || $input.first().json;\nconst question = body.question || '';\nconst sessionId = body.sessionId || 'default';\nconst userId = body.userId;\nconst context = body.context || {};\n\n// æ²³åŒ—çº¢è‰²æ—…æ¸¸çŸ¥è¯†åº“\nconst knowledgeBase = {\n  'è¥¿æŸå¡': {\n    intro: 'è¥¿æŸå¡çºªå¿µé¦†ä½äºæ²³åŒ—çœçŸ³å®¶åº„å¸‚å¹³å±±å¿ï¼Œæ˜¯è§£æ”¾æˆ˜äº‰æ—¶æœŸä¸­å¤®å·¥å§”ã€ä¸­å…±ä¸­å¤®å’Œè§£æ”¾å†›æ€»éƒ¨çš„æ‰€åœ¨åœ°ï¼Œè¢«èª‰ä¸º\"æ–°ä¸­å›½ä»è¿™é‡Œèµ°æ¥\"ã€‚',\n    highlights: ['ä¸ƒå±ŠäºŒä¸­å…¨ä¼šä¼šå€', 'æ¯›æ³½ä¸œæ—§å±…', 'ä¸­å¤®å†›å§”ä½œæˆ˜å®¤', 'è¥¿æŸå¡é™ˆåˆ—é¦†'],\n    tickets: 'å…è´¹å‚è§‚ï¼Œéœ€æå‰åœ¨å®˜æ–¹å¹³å°é¢„çº¦',\n    hours: '9:00-17:00ï¼Œå‘¨ä¸€é—­é¦†',\n    duration: 'å»ºè®®æ¸¸è§ˆ2-3å°æ—¶',\n    transport: 'ä»çŸ³å®¶åº„å¸‚åŒºé©¾è½¦çº¦1.5å°æ—¶ï¼Œä¹Ÿå¯ä¹˜åæ—…æ¸¸ä¸“çº¿',\n    tips: ['æºå¸¦èº«ä»½è¯', 'ç©¿èˆ’é€‚çš„é‹å­', 'å»ºè®®è¯·è®²è§£å‘˜']\n  },\n  'ç‹¼ç‰™å±±': {\n    intro: 'ç‹¼ç‰™å±±ä½äºæ²³åŒ—çœä¿å®šå¸‚æ˜“å¿ï¼Œå› å¥‡å³°æ—ç«‹çŠ¶è‹¥ç‹¼ç‰™è€Œå¾—åã€‚è¿™é‡Œæ˜¯ç‹¼ç‰™å±±äº”å£®å£«è‹±é›„äº‹è¿¹å‘ç”Ÿåœ°ã€‚',\n    highlights: ['æ£‹ç›˜é™€', 'äº”å£®å£«çºªå¿µå¡”', 'äº”å£®å£«é™ˆåˆ—é¦†', 'ç‹¼ç‰™å±±ç»ç’ƒæ ˆé“'],\n    tickets: 'é—¨ç¥¨80å…ƒï¼Œç´¢é“å¾€è¿”100å…ƒ',\n    hours: '8:00-17:00',\n    duration: 'å»ºè®®æ¸¸è§ˆ3-4å°æ—¶',\n    transport: 'ä»ä¿å®šå¸‚åŒºé©¾è½¦çº¦1å°æ—¶',\n    tips: ['å±±è·¯è¾ƒé™¡æ³¨æ„å®‰å…¨', 'å»ºè®®æºå¸¦é¥®ç”¨æ°´', 'æé«˜è€…æ…é€‰ç»ç’ƒæ ˆé“']\n  },\n  'ç™½æ´‹æ·€': {\n    intro: 'ç™½æ´‹æ·€æ˜¯ååŒ—å¹³åŸæœ€å¤§çš„æ·¡æ°´æ¹–æ³Šï¼Œç´ æœ‰\"ååŒ—æ˜ç \"ä¹‹ç§°ã€‚æŠ—æˆ˜æ—¶æœŸé›ç¿é˜Ÿåœ¨æ­¤åˆ›é€ äº†æ°´ä¸Šæ¸¸å‡»æˆ˜ä¼ å¥‡ã€‚',\n    highlights: ['é›ç¿é˜Ÿçºªå¿µé¦†', 'è·èŠ±å¤§è§‚å›­', 'å˜å­æ‘', 'ç™½æ´‹æ·€æ¹¿åœ°'],\n    tickets: 'é—¨ç¥¨40å…ƒï¼Œèˆ¹ç¥¨å¦è®¡',\n    hours: '8:00-18:00ï¼ˆå¤å­£ï¼‰',\n    duration: 'å»ºè®®æ¸¸è§ˆåŠå¤©åˆ°ä¸€å¤©',\n    transport: 'ä»ä¿å®šå¸‚åŒºé©¾è½¦çº¦40åˆ†é’Ÿ',\n    tips: ['å¤å­£è·èŠ±ç››å¼€æœ€ç¾', 'å¯ä¹˜èˆ¹æ¸¸è§ˆ', 'å“å°ç™½æ´‹æ·€ç‚–æ‚é±¼']\n  },\n  'å¡ç½•å': {\n    intro: 'å¡ç½•åä½äºæ²³åŒ—çœæ‰¿å¾·å¸‚å›´åœºå¿ï¼Œæ˜¯ä¸–ç•Œä¸Šé¢ç§¯æœ€å¤§çš„äººå·¥æ—åœºã€‚ä¸‰ä»£å¡ç½•åäººç”¨55å¹´æ—¶é—´å°†è’åŸå˜æˆç™¾ä¸‡äº©æ—æµ·ã€‚',\n    highlights: ['å¡ç½•åå±•è§ˆé¦†', 'æœ›æµ·æ¥¼', 'ä¸ƒæ˜Ÿæ¹–æ¹¿åœ°', 'å¤ªé˜³æ¹–'],\n    tickets: 'é—¨ç¥¨130å…ƒï¼ˆæ—ºå­£ï¼‰',\n    hours: 'å…¨å¤©å¼€æ”¾',\n    duration: 'å»ºè®®æ¸¸è§ˆ1-2å¤©',\n    transport: 'ä»æ‰¿å¾·å¸‚åŒºé©¾è½¦çº¦4å°æ—¶',\n    tips: ['å¤å­£å‡‰çˆ½æ˜¯é¿æš‘èƒœåœ°', 'ç§‹å­£è‰²å½©æ–‘æ–“æœ€ç¾', 'æ³¨æ„é˜²æ™’å’Œä¿æš–']\n  }\n};\n\n// ç¾é£Ÿæ¨è\nconst foodGuide = {\n  'å¹³å±±': ['ç¼¸ç‚‰çƒ§é¥¼', 'å¹³å±±æŠ¿é¡»é¢', 'å†œå®¶ç‚–èœ'],\n  'ä¿å®š': ['é©´è‚‰ç«çƒ§', 'ç™½è¿ç« åŒ…å­', 'å¤ç…®é¸¡'],\n  'ç™½æ´‹æ·€': ['ç™½æ´‹æ·€ç‚–æ‚é±¼', 'è·å¶é¸¡', 'è²è—•'],\n  'æ‰¿å¾·': ['æ‰¿å¾·çƒ¤å…¨ç¾Š', 'åä¸Šèœé¢', 'å±±é‡èœ']\n};\n\n// è·¯çº¿æ¨è\nconst routeTemplates = {\n  'ä¸€æ—¥æ¸¸': {\n    title: 'è¥¿æŸå¡çº¢è‰²ç»å…¸ä¸€æ—¥æ¸¸',\n    spots: ['è¥¿æŸå¡çºªå¿µé¦†', 'ä¸ƒå±ŠäºŒä¸­å…¨ä¼šä¼šå€', 'æ¯›æ³½ä¸œæ—§å±…'],\n    cost: 200,\n    tips: 'ä¸Šåˆå‚è§‚çºªå¿µé¦†ï¼Œä¸­åˆå“å°å½“åœ°å†œå®¶èœ'\n  },\n  'ä¸¤æ—¥æ¸¸': {\n    title: 'å¤ªè¡Œå±±çº¢è‰²ç”Ÿæ€ä¸¤æ—¥æ¸¸',\n    day1: ['è¥¿æŸå¡çºªå¿µé¦†', 'çŸ³å®¶åº„è§£æ”¾çºªå¿µé¦†'],\n    day2: ['ç‹¼ç‰™å±±äº”å£®å£«çºªå¿µåœ°', 'æ˜“å¿æ¸…è¥¿é™µ'],\n    cost: 600,\n    tips: 'ç¬¬ä¸€å¤©ä½å¹³å±±å¿åŸï¼Œç¬¬äºŒå¤©å‰å¾€ä¿å®šæ–¹å‘'\n  },\n  'ä¸‰æ—¥æ¸¸': {\n    title: 'æ²³åŒ—çº¢è‰²æ–‡åŒ–æ·±åº¦æ¸¸',\n    day1: ['è¥¿æŸå¡çºªå¿µé¦†'],\n    day2: ['ç™½æ´‹æ·€é›ç¿é˜Ÿçºªå¿µé¦†', 'è·èŠ±å¤§è§‚å›­'],\n    day3: ['ç‹¼ç‰™å±±äº”å£®å£«çºªå¿µåœ°'],\n    cost: 1000,\n    tips: 'æ·±åº¦ä½“éªŒæ²³åŒ—çº¢è‰²æ–‡åŒ–ç²¾å'\n  }\n};\n\nreturn {\n  question,\n  sessionId,\n  userId,\n  context,\n  knowledgeBase,\n  foodGuide,\n  routeTemplates\n};"
      },
      "id": "prepare-context",
      "name": "å‡†å¤‡å¯¹è¯ä¸Šä¸‹æ–‡",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.deepseek.com/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" },
            { "name": "Authorization", "value": "Bearer {{$env.DEEPSEEK_API_KEY}}" }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "model", "value": "deepseek-chat" },
            { "name": "messages", "value": "=[{\"role\":\"system\",\"content\":\"ä½ æ˜¯å†€å°æ¸¸ï¼Œæ²³åŒ—çº¢è‰²æ—…æ¸¸æ™ºèƒ½åŠ©æ‰‹ã€‚ä½ çƒ­æƒ…å‹å¥½ï¼Œå¯¹æ²³åŒ—çº¢è‰²æ—…æ¸¸æ™¯ç‚¹éå¸¸ç†Ÿæ‚‰ã€‚\\n\\nçŸ¥è¯†åº“ï¼š\" + JSON.stringify($json.knowledgeBase) + \"\\n\\nç¾é£Ÿï¼š\" + JSON.stringify($json.foodGuide) + \"\\n\\nè·¯çº¿ï¼š\" + JSON.stringify($json.routeTemplates) + \"\\n\\nå›ç­”è§„åˆ™ï¼š1.äº²åˆ‡è¯­æ°”å¸¦emoji 2.ç®€æ´å®ç”¨ 3.æ™¯ç‚¹æä¾›é—¨ç¥¨æ—¶é—´äº¤é€š 4.è·¯çº¿æŒ‰å¤©æ•°æ¨è 5.ä¸çŸ¥é“å°±è¯´ä¸æ¸…æ¥š\"},{\"role\":\"user\",\"content\":\"\" + $json.question + \"\"}]" },
            { "name": "temperature", "value": "0.7" },
            { "name": "max_tokens", "value": "1000" }
          ]
        },
        "options": {}
      },
      "id": "ai-chat",
      "name": "AI ç”Ÿæˆå›ç­”",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [750, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// è§£æAIå“åº”æˆ–ä½¿ç”¨è§„åˆ™å¼•æ“\nconst preparedData = $('å‡†å¤‡å¯¹è¯ä¸Šä¸‹æ–‡').first().json;\nconst question = (preparedData.question || '').toLowerCase();\nlet response;\n\ntry {\n  const aiResponse = $('AI ç”Ÿæˆå›ç­”').first().json;\n  // DeepSeek API å“åº”æ ¼å¼\n  const content = aiResponse.choices?.[0]?.message?.content || '';\n  if (content) {\n    // å°è¯•è§£æJSONï¼Œå¦‚æœå¤±è´¥åˆ™ç›´æ¥ä½¿ç”¨æ–‡æœ¬\n    try {\n      const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        response = JSON.parse(jsonMatch[0]);\n      }\n    } catch (e) {\n      response = { answer: content, type: 'general' };\n    }\n    if (!response) {\n      response = { answer: content, type: 'general' };\n    }\n  }\n} catch (e) {\n  // AIå¤±è´¥ï¼Œä½¿ç”¨è§„åˆ™å¼•æ“\n}\n\nif (!response || !response.answer) {\n  // è§„åˆ™å¼•æ“é™çº§\n  const kb = preparedData.knowledgeBase;\n  const food = preparedData.foodGuide;\n  const routes = preparedData.routeTemplates;\n  \n  response = {\n    type: 'general',\n    suggestions: ['è¥¿æŸå¡æœ‰ä»€ä¹ˆå¿…çœ‹æ™¯ç‚¹ï¼Ÿ', 'æ¨èä¸€æ—¥æ¸¸è·¯çº¿', 'é™„è¿‘æœ‰ä»€ä¹ˆç¾é£Ÿï¼Ÿ']\n  };\n  \n  // æ™¯ç‚¹æŸ¥è¯¢\n  for (const [spot, info] of Object.entries(kb)) {\n    if (question.includes(spot.toLowerCase())) {\n      if (question.includes('é—¨ç¥¨') || question.includes('ç¥¨ä»·')) {\n        response.answer = `ğŸ« ${spot}é—¨ç¥¨ä¿¡æ¯ï¼š${info.tickets}\\n\\nâ° å¼€æ”¾æ—¶é—´ï¼š${info.hours}\\n\\nğŸ’¡ å°è´´å£«ï¼š${info.tips.join('ã€')}`;\n        response.type = 'spot_info';\n      } else if (question.includes('æ€ä¹ˆå»') || question.includes('äº¤é€š')) {\n        response.answer = `ğŸš— å‰å¾€${spot}çš„äº¤é€šæ–¹å¼ï¼š\\n${info.transport}\\n\\nâ±ï¸ å»ºè®®æ¸¸è§ˆæ—¶é—´ï¼š${info.duration}`;\n        response.type = 'spot_info';\n      } else {\n        response.answer = `ğŸ›ï¸ ${spot}\\n\\n${info.intro}\\n\\nâœ¨ å¿…çœ‹æ™¯ç‚¹ï¼š${info.highlights.join('ã€')}\\n\\nğŸ« é—¨ç¥¨ï¼š${info.tickets}\\nâ° å¼€æ”¾æ—¶é—´ï¼š${info.hours}\\nâ±ï¸ å»ºè®®æ¸¸è§ˆï¼š${info.duration}`;\n        response.type = 'spot_info';\n      }\n      response.relatedSpots = [spot];\n      response.suggestions = [`${spot}é—¨ç¥¨å¤šå°‘é’±ï¼Ÿ`, `${spot}æ€ä¹ˆå»ï¼Ÿ`, `${spot}é™„è¿‘æœ‰ä»€ä¹ˆç¾é£Ÿï¼Ÿ`];\n      break;\n    }\n  }\n  \n  // è·¯çº¿æŸ¥è¯¢\n  if (!response.answer && (question.includes('è·¯çº¿') || question.includes('æ¸¸') || question.includes('æ¨è'))) {\n    if (question.includes('ä¸€æ—¥') || question.includes('1å¤©')) {\n      const r = routes['ä¸€æ—¥æ¸¸'];\n      response.answer = `ğŸ“ ${r.title}\\n\\nğŸ—ºï¸ è¡Œç¨‹å®‰æ’ï¼š${r.spots.join(' â†’ ')}\\n\\nğŸ’° é¢„è®¡è´¹ç”¨ï¼šçº¦${r.cost}å…ƒ/äºº\\n\\nğŸ’¡ ${r.tips}`;\n    } else if (question.includes('ä¸¤æ—¥') || question.includes('2å¤©')) {\n      const r = routes['ä¸¤æ—¥æ¸¸'];\n      response.answer = `ğŸ“ ${r.title}\\n\\nğŸ—ºï¸ Day1ï¼š${r.day1.join(' â†’ ')}\\nğŸ—ºï¸ Day2ï¼š${r.day2.join(' â†’ ')}\\n\\nğŸ’° é¢„è®¡è´¹ç”¨ï¼šçº¦${r.cost}å…ƒ/äºº\\n\\nğŸ’¡ ${r.tips}`;\n    } else {\n      const r = routes['ä¸‰æ—¥æ¸¸'];\n      response.answer = `ğŸ“ ${r.title}\\n\\nğŸ—ºï¸ Day1ï¼š${r.day1.join(' â†’ ')}\\nğŸ—ºï¸ Day2ï¼š${r.day2.join(' â†’ ')}\\nğŸ—ºï¸ Day3ï¼š${r.day3.join(' â†’ ')}\\n\\nğŸ’° é¢„è®¡è´¹ç”¨ï¼šçº¦${r.cost}å…ƒ/äºº\\n\\nğŸ’¡ ${r.tips}`;\n    }\n    response.type = 'route';\n    response.suggestions = ['ä¸€æ—¥æ¸¸è·¯çº¿', 'ä¸¤æ—¥æ¸¸è·¯çº¿', 'ä¸‰æ—¥æ¸¸è·¯çº¿'];\n  }\n  \n  // ç¾é£ŸæŸ¥è¯¢\n  if (!response.answer && (question.includes('ç¾é£Ÿ') || question.includes('åƒ') || question.includes('ç‰¹äº§'))) {\n    let foodAnswer = 'ğŸœ æ²³åŒ—çº¢è‰²æ—…æ¸¸æ²¿çº¿ç‰¹è‰²ç¾é£Ÿæ¨èï¼š\\n\\n';\n    for (const [area, foods] of Object.entries(food)) {\n      foodAnswer += `ğŸ“ ${area}ï¼š${foods.join('ã€')}\\n`;\n    }\n    foodAnswer += '\\nğŸ’° äººå‡æ¶ˆè´¹ï¼š30-80å…ƒ';\n    response.answer = foodAnswer;\n    response.type = 'food';\n    response.suggestions = ['å¹³å±±æœ‰ä»€ä¹ˆå¥½åƒçš„ï¼Ÿ', 'ç™½æ´‹æ·€ç‰¹è‰²èœ', 'æ‰¿å¾·ç¾é£Ÿæ¨è'];\n  }\n  \n  // å¤©æ°”æŸ¥è¯¢\n  if (!response.answer && (question.includes('å¤©æ°”') || question.includes('ç©¿'))) {\n    response.answer = 'ğŸŒ¤ï¸ å½“å‰å¤©æ°”æƒ…å†µï¼š\\n\\næ²³åŒ—åœ°åŒºä»Šæ—¥æ™´ï¼Œæ°”æ¸©3-12â„ƒ\\n\\nğŸ‘” ç©¿è¡£å»ºè®®ï¼š\\n- å»ºè®®ç©¿ä¿æš–å¤–å¥—å’Œèˆ’é€‚è¿åŠ¨é‹\\n- å±±åŒºæ—©æ™šæ¸©å·®å¤§ï¼Œæ³¨æ„ä¿æš–\\n- æˆ·å¤–æ´»åŠ¨æ³¨æ„é˜²æ™’\\n\\nâ˜” å‡ºè¡Œæç¤ºï¼šè¿‘æœŸå¤©æ°”é€‚å®œå‡ºè¡Œ';\n    response.type = 'weather';\n    response.suggestions = ['è¥¿æŸå¡å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ', 'ç‹¼ç‰™å±±é€‚åˆä»€ä¹ˆå­£èŠ‚å»ï¼Ÿ', 'å¡ç½•åæœ€ä½³æ—…æ¸¸æ—¶é—´'];\n  }\n  \n  // é»˜è®¤å›ç­”\n  if (!response.answer) {\n    response.answer = 'ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯å†€å°æ¸¸ï¼Œæ²³åŒ—çº¢è‰²æ—…æ¸¸æ™ºèƒ½åŠ©æ‰‹ã€‚\\n\\næˆ‘å¯ä»¥å¸®æ‚¨ï¼š\\nğŸ›ï¸ æŸ¥è¯¢æ™¯ç‚¹ä¿¡æ¯ï¼ˆé—¨ç¥¨ã€å¼€æ”¾æ—¶é—´ã€äº¤é€šï¼‰\\nğŸ—ºï¸ è§„åˆ’æ—…æ¸¸è·¯çº¿\\nğŸœ æ¨èå½“åœ°ç¾é£Ÿ\\nğŸŒ¤ï¸ æŸ¥è¯¢å¤©æ°”ç©¿è¡£å»ºè®®\\n\\nè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„ï¼Ÿ';\n    response.type = 'general';\n  }\n}\n\n// ç¡®ä¿æœ‰suggestions\nif (!response.suggestions) {\n  response.suggestions = ['è¥¿æŸå¡æœ‰ä»€ä¹ˆå¿…çœ‹æ™¯ç‚¹ï¼Ÿ', 'æ¨èä¸€æ—¥æ¸¸è·¯çº¿', 'é™„è¿‘æœ‰ä»€ä¹ˆç¾é£Ÿï¼Ÿ'];\n}\n\n// æ·»åŠ ä¼šè¯ID\nresponse.sessionId = preparedData.sessionId;\nresponse.timestamp = new Date().toISOString();\n\nreturn response;"
      },
      "id": "process-response",
      "name": "å¤„ç†AIå“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}"
      },
      "id": "respond-chat",
      "name": "è¿”å›å›ç­”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1250, 300]
    }
  ],
  "connections": {
    "Webhook é—®ç­”è¯·æ±‚": {
      "main": [[{ "node": "å‡†å¤‡å¯¹è¯ä¸Šä¸‹æ–‡", "type": "main", "index": 0 }]]
    },
    "å‡†å¤‡å¯¹è¯ä¸Šä¸‹æ–‡": {
      "main": [[{ "node": "AI ç”Ÿæˆå›ç­”", "type": "main", "index": 0 }]]
    },
    "AI ç”Ÿæˆå›ç­”": {
      "main": [[{ "node": "å¤„ç†AIå“åº”", "type": "main", "index": 0 }]]
    },
    "å¤„ç†AIå“åº”": {
      "main": [[{ "node": "è¿”å›å›ç­”", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
