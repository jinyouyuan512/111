<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½œå“è¯¦æƒ…åª’ä½“æ˜¾ç¤ºè¯Šæ–­</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f7fa;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
    }
    h1 {
      color: #a0182f;
      border-bottom: 3px solid #a0182f;
      padding-bottom: 10px;
    }
    h2 {
      color: #333;
      margin-top: 30px;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 6px;
    }
    .step {
      background: #fff9e6;
      border-left: 4px solid #ffd700;
      padding: 15px;
      margin: 15px 0;
    }
    .result {
      background: #f0f9ff;
      border: 1px solid #409eff;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
    }
    .error {
      background: #fef0f0;
      border: 1px solid #f56c6c;
      color: #f56c6c;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
    }
    .success {
      background: #f0f9ff;
      border: 1px solid #67c23a;
      color: #67c23a;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
    }
    button {
      background: #a0182f;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #8b1538;
    }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
    }
    .work-card {
      border: 1px solid #e0e0e0;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #fafafa;
    }
    .work-card h3 {
      margin: 0 0 10px 0;
      color: #a0182f;
    }
    .field {
      margin: 8px 0;
      padding: 8px;
      background: white;
      border-radius: 4px;
    }
    .field-label {
      font-weight: bold;
      color: #666;
      display: inline-block;
      width: 150px;
    }
    .field-value {
      color: #333;
    }
    .media-preview {
      margin: 15px 0;
      padding: 15px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
    }
    .media-preview img,
    .media-preview video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 6px;
    }
    .warning {
      background: #fff3e0;
      border: 1px solid #ff9800;
      color: #ff6f00;
      padding: 15px;
      margin: 15px 0;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¨ ä½œå“è¯¦æƒ…åª’ä½“æ˜¾ç¤ºè¯Šæ–­å·¥å…·</h1>
    
    <div class="step">
      <strong>ğŸ“‹ è¯Šæ–­ç›®çš„ï¼š</strong>
      <p>æ£€æŸ¥ä¸Šä¼ çš„ä½œå“æ•°æ®ä¸­ coverImage å’Œ files å­—æ®µæ˜¯å¦æ­£ç¡®ä¿å­˜ï¼Œä»¥åŠä¸ºä»€ä¹ˆåœ¨è¯¦æƒ…å¼¹çª—ä¸­ä¸æ˜¾ç¤ºå›¾ç‰‡/è§†é¢‘ã€‚</p>
    </div>

    <h2>æ­¥éª¤ 1: è·å–ä½œå“åˆ—è¡¨</h2>
    <button onclick="loadWorks()">ğŸ” åŠ è½½æ‰€æœ‰ä½œå“</button>
    <div id="worksResult"></div>

    <h2>æ­¥éª¤ 2: æ£€æŸ¥ç‰¹å®šä½œå“</h2>
    <div class="step">
      <p>è¾“å…¥ä½œå“IDæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼š</p>
      <input type="number" id="workId" placeholder="è¾“å…¥ä½œå“ID" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
      <button onclick="checkWork()">ğŸ” æ£€æŸ¥ä½œå“</button>
    </div>
    <div id="workDetail"></div>

    <h2>æ­¥éª¤ 3: æµ‹è¯•åª’ä½“URL</h2>
    <div class="step">
      <p>è¾“å…¥å›¾ç‰‡æˆ–è§†é¢‘URLæµ‹è¯•æ˜¯å¦å¯è®¿é—®ï¼š</p>
      <input type="text" id="mediaUrl" placeholder="è¾“å…¥åª’ä½“URL" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 500px;">
      <button onclick="testMedia()">ğŸ–¼ï¸ æµ‹è¯•åª’ä½“</button>
    </div>
    <div id="mediaTest"></div>

    <h2>æ­¥éª¤ 4: è§£å†³æ–¹æ¡ˆ</h2>
    <div id="solutions"></div>
  </div>

  <script>
    const API_BASE = 'http://localhost:8083/api/creative';
    
    // è·å–Token
    function getToken() {
      return localStorage.getItem('token');
    }

    // åŠ è½½æ‰€æœ‰ä½œå“
    async function loadWorks() {
      const resultDiv = document.getElementById('worksResult');
      resultDiv.innerHTML = '<p>â³ æ­£åœ¨åŠ è½½ä½œå“...</p>';

      try {
        const response = await fetch(`${API_BASE}/designs/top?limit=100`, {
          headers: {
            'Authorization': `Bearer ${getToken()}`
          }
        });

        console.log('å“åº”çŠ¶æ€:', response.status);
        const data = await response.json();
        console.log('ä½œå“æ•°æ®:', data);

        if (data.code === 200 && data.data) {
          const works = data.data;
          
          let html = `<div class="success">âœ… æˆåŠŸåŠ è½½ ${works.length} ä¸ªä½œå“</div>`;
          
          // æ£€æŸ¥æ¯ä¸ªä½œå“çš„åª’ä½“å­—æ®µ
          works.forEach(work => {
            const hasCover = work.coverImage && work.coverImage.trim().length > 0;
            const hasFiles = work.files && work.files.length > 0;
            const filesArray = typeof work.files === 'string' ? work.files.split(',') : work.files;
            
            html += `
              <div class="work-card">
                <h3>ä½œå“ #${work.id}: ${work.title}</h3>
                <div class="field">
                  <span class="field-label">åˆ†ç±»ç±»å‹:</span>
                  <span class="field-value">${work.categoryType || 'æœªè®¾ç½®'}</span>
                </div>
                <div class="field">
                  <span class="field-label">å°é¢å›¾ç‰‡:</span>
                  <span class="field-value" style="color: ${hasCover ? 'green' : 'red'}">
                    ${hasCover ? 'âœ… å·²è®¾ç½®' : 'âŒ æœªè®¾ç½®'}
                  </span>
                </div>
                ${hasCover ? `
                  <div class="field">
                    <span class="field-label">å°é¢URL:</span>
                    <span class="field-value" style="font-size: 12px; word-break: break-all;">${work.coverImage}</span>
                  </div>
                ` : ''}
                <div class="field">
                  <span class="field-label">ä½œå“æ–‡ä»¶:</span>
                  <span class="field-value" style="color: ${hasFiles ? 'green' : 'red'}">
                    ${hasFiles ? `âœ… ${filesArray.length} ä¸ªæ–‡ä»¶` : 'âŒ æœªè®¾ç½®'}
                  </span>
                </div>
                ${hasFiles ? `
                  <div class="field">
                    <span class="field-label">æ–‡ä»¶åˆ—è¡¨:</span>
                    <div style="margin-left: 150px; font-size: 12px;">
                      ${filesArray.map((f, i) => `<div>${i + 1}. ${f}</div>`).join('')}
                    </div>
                  </div>
                ` : ''}
                <div class="field">
                  <span class="field-label">è®¾è®¡å¸ˆID:</span>
                  <span class="field-value">${work.designerId}</span>
                </div>
                <div class="field">
                  <span class="field-label">åˆ›å»ºæ—¶é—´:</span>
                  <span class="field-value">${work.createdAt}</span>
                </div>
                <button onclick="checkWorkById(${work.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                ${hasCover ? `<button onclick="previewMedia('${work.coverImage}', 'image')">é¢„è§ˆå°é¢</button>` : ''}
              </div>
            `;
          });

          resultDiv.innerHTML = html;

          // ç»Ÿè®¡åˆ†æ
          const withCover = works.filter(w => w.coverImage && w.coverImage.trim().length > 0).length;
          const withFiles = works.filter(w => w.files && w.files.length > 0).length;
          
          resultDiv.innerHTML += `
            <div class="result">
              <h3>ğŸ“Š ç»Ÿè®¡åˆ†æ</h3>
              <p>æ€»ä½œå“æ•°: ${works.length}</p>
              <p>æœ‰å°é¢å›¾ç‰‡: ${withCover} (${(withCover/works.length*100).toFixed(1)}%)</p>
              <p>æœ‰ä½œå“æ–‡ä»¶: ${withFiles} (${(withFiles/works.length*100).toFixed(1)}%)</p>
            </div>
          `;

          // å¦‚æœæœ‰ä½œå“ç¼ºå°‘åª’ä½“ï¼Œæ˜¾ç¤ºè­¦å‘Š
          if (withCover < works.length || withFiles < works.length) {
            showSolutions();
          }

        } else {
          resultDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
        }
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        resultDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æ£€æŸ¥ç‰¹å®šä½œå“
    async function checkWork() {
      const workId = document.getElementById('workId').value;
      if (!workId) {
        alert('è¯·è¾“å…¥ä½œå“ID');
        return;
      }
      await checkWorkById(workId);
    }

    async function checkWorkById(workId) {
      const detailDiv = document.getElementById('workDetail');
      detailDiv.innerHTML = '<p>â³ æ­£åœ¨åŠ è½½ä½œå“è¯¦æƒ…...</p>';

      try {
        const response = await fetch(`${API_BASE}/designs/${workId}`, {
          headers: {
            'Authorization': `Bearer ${getToken()}`
          }
        });

        const data = await response.json();
        console.log('ä½œå“è¯¦æƒ…:', data);

        if (data.code === 200 && data.data) {
          const work = data.data;
          const filesArray = typeof work.files === 'string' ? work.files.split(',') : work.files;
          
          let html = `
            <div class="success">âœ… æˆåŠŸåŠ è½½ä½œå“è¯¦æƒ…</div>
            <div class="work-card">
              <h3>ä½œå“ #${work.id}: ${work.title}</h3>
              <pre>${JSON.stringify(work, null, 2)}</pre>
              
              ${work.coverImage ? `
                <div class="media-preview">
                  <h4>å°é¢å›¾ç‰‡é¢„è§ˆ:</h4>
                  <img src="${work.coverImage}" alt="å°é¢" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                  <div style="display:none; color: red;">âŒ å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                </div>
              ` : '<div class="warning">âš ï¸ è¯¥ä½œå“æ²¡æœ‰å°é¢å›¾ç‰‡</div>'}
              
              ${filesArray && filesArray.length > 0 ? `
                <div class="media-preview">
                  <h4>ä½œå“æ–‡ä»¶é¢„è§ˆ:</h4>
                  ${filesArray.map((file, i) => {
                    const isVideo = file.includes('.mp4') || file.includes('.webm') || file.includes('video');
                    if (isVideo) {
                      return `
                        <div>
                          <p>æ–‡ä»¶ ${i + 1}: è§†é¢‘</p>
                          <video src="${file}" controls style="max-width: 100%; max-height: 400px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                          </video>
                          <div style="display:none; color: red;">âŒ è§†é¢‘åŠ è½½å¤±è´¥</div>
                        </div>
                      `;
                    } else {
                      return `
                        <div>
                          <p>æ–‡ä»¶ ${i + 1}: å›¾ç‰‡</p>
                          <img src="${file}" alt="ä½œå“æ–‡ä»¶" style="max-width: 100%; max-height: 400px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                          <div style="display:none; color: red;">âŒ å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                        </div>
                      `;
                    }
                  }).join('')}
                </div>
              ` : '<div class="warning">âš ï¸ è¯¥ä½œå“æ²¡æœ‰ä½œå“æ–‡ä»¶</div>'}
            </div>
          `;

          detailDiv.innerHTML = html;
        } else {
          detailDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
        }
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        detailDiv.innerHTML = `<div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æµ‹è¯•åª’ä½“URL
    function testMedia() {
      const url = document.getElementById('mediaUrl').value;
      if (!url) {
        alert('è¯·è¾“å…¥åª’ä½“URL');
        return;
      }
      previewMedia(url, 'auto');
    }

    function previewMedia(url, type) {
      const testDiv = document.getElementById('mediaTest');
      
      const isVideo = type === 'video' || url.includes('.mp4') || url.includes('.webm') || url.includes('video');
      
      if (isVideo) {
        testDiv.innerHTML = `
          <div class="media-preview">
            <h4>è§†é¢‘é¢„è§ˆ:</h4>
            <p>URL: ${url}</p>
            <video src="${url}" controls style="max-width: 100%; max-height: 400px;" onerror="handleMediaError(this)">
              æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
            </video>
          </div>
        `;
      } else {
        testDiv.innerHTML = `
          <div class="media-preview">
            <h4>å›¾ç‰‡é¢„è§ˆ:</h4>
            <p>URL: ${url}</p>
            <img src="${url}" alt="é¢„è§ˆ" style="max-width: 100%; max-height: 400px;" onerror="handleMediaError(this)">
          </div>
        `;
      }
    }

    function handleMediaError(element) {
      element.style.display = 'none';
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.innerHTML = 'âŒ åª’ä½“åŠ è½½å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› ï¼š<br>1. URLä¸æ­£ç¡®<br>2. æ–‡ä»¶ä¸å­˜åœ¨<br>3. è·¨åŸŸé—®é¢˜<br>4. ç½‘ç»œé—®é¢˜';
      element.parentNode.appendChild(errorDiv);
    }

    // æ˜¾ç¤ºè§£å†³æ–¹æ¡ˆ
    function showSolutions() {
      const solutionsDiv = document.getElementById('solutions');
      solutionsDiv.innerHTML = `
        <div class="warning">
          <h3>âš ï¸ å‘ç°é—®é¢˜</h3>
          <p>éƒ¨åˆ†ä½œå“ç¼ºå°‘å°é¢å›¾ç‰‡æˆ–ä½œå“æ–‡ä»¶ï¼Œè¿™ä¼šå¯¼è‡´è¯¦æƒ…å¼¹çª—ä¸­æ— æ³•æ˜¾ç¤ºåª’ä½“å†…å®¹ã€‚</p>
        </div>
        
        <div class="result">
          <h3>ğŸ”§ è§£å†³æ–¹æ¡ˆ</h3>
          
          <h4>æ–¹æ¡ˆ 1: æ£€æŸ¥ä¸Šä¼ æµç¨‹</h4>
          <ol>
            <li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰</li>
            <li>è¿›å…¥"ä¼—åˆ›ç©ºé—´" â†’ ç‚¹å‡»"ä¸Šä¼ ä½œå“"</li>
            <li>ä¸Šä¼ å°é¢å›¾ç‰‡å’Œä½œå“æ–‡ä»¶</li>
            <li>è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼Œç¡®è®¤æ–‡ä»¶ä¸Šä¼ æˆåŠŸå¹¶è¿”å›URL</li>
            <li>æäº¤ä½œå“åï¼Œæ£€æŸ¥è¯·æ±‚æ•°æ®ä¸­æ˜¯å¦åŒ…å« coverImage å’Œ files å­—æ®µ</li>
          </ol>
          
          <h4>æ–¹æ¡ˆ 2: ä¿®æ”¹ Creative.vue æ˜¾ç¤ºé€»è¾‘</h4>
          <p>å¦‚æœä½œå“æ•°æ®ä¸­ coverImage ä¸ºç©ºï¼Œå¯ä»¥ä½¿ç”¨ files æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ä½œä¸ºå°é¢ï¼š</p>
          <pre>
// åœ¨ loadDesigns å‡½æ•°ä¸­ï¼Œè½¬æ¢æ•°æ®æ—¶æ·»åŠ ï¼š
coverImage: design.coverImage || (design.files && design.files.length > 0 ? design.files[0] : 'é»˜è®¤å›¾ç‰‡URL')
          </pre>
          
          <h4>æ–¹æ¡ˆ 3: ä¿®æ”¹è¯¦æƒ…å¼¹çª—æ˜¾ç¤ºé€»è¾‘</h4>
          <p>åœ¨è¯¦æƒ…å¼¹çª—ä¸­ï¼Œå¦‚æœ coverImage ä¸ºç©ºï¼Œæ˜¾ç¤º files ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼š</p>
          <pre>
&lt;div v-if="isVideoWork(currentWork)" class="media-video"&gt;
  &lt;video 
    :src="currentWork.files && currentWork.files.length > 0 ? currentWork.files[0] : getVideoUrl(currentWork)" 
    controls 
    class="video-player"
    :poster="currentWork.coverImage"
  &gt;&lt;/video&gt;
&lt;/div&gt;
&lt;div v-else class="media-image"&gt;
  &lt;img 
    :src="currentWork.coverImage || (currentWork.files && currentWork.files.length > 0 ? currentWork.files[0] : '')" 
    :alt="currentWork.title" 
  /&gt;
&lt;/div&gt;
          </pre>
          
          <h4>æ–¹æ¡ˆ 4: åç«¯æ•°æ®ä¿®å¤</h4>
          <p>å¦‚æœæ•°æ®åº“ä¸­å·²æœ‰ä½œå“ä½†ç¼ºå°‘ coverImageï¼Œå¯ä»¥è¿è¡ŒSQLæ›´æ–°ï¼š</p>
          <pre>
-- å°† files å­—æ®µçš„ç¬¬ä¸€ä¸ªURLå¤åˆ¶åˆ° coverImage
UPDATE design 
SET cover_image = SUBSTRING_INDEX(files, ',', 1)
WHERE cover_image IS NULL OR cover_image = '';
          </pre>
        </div>
      `;
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
    window.onload = function() {
      console.log('=== ä½œå“è¯¦æƒ…åª’ä½“æ˜¾ç¤ºè¯Šæ–­å·¥å…· ===');
      console.log('Token:', getToken() ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
    };
  </script>
</body>
</html>
