<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´è¯Šæ–­ - ä¸Šä¼ æ–‡ä»¶ä¸æ˜¾ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
        }
        .section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .section h2 {
            color: #667eea;
            margin-top: 0;
        }
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 5px;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .result {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #17a2b8; }
        .warning { color: #ffc107; font-weight: bold; }
        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å®Œæ•´è¯Šæ–­ - ä¸Šä¼ æ–‡ä»¶ä¸æ˜¾ç¤º</h1>

        <div class="section">
            <h2>æ­¥éª¤ 1ï¼šæµ‹è¯•æœ€æ–°ä¸Šä¼ çš„æ–‡ä»¶</h2>
            <p>è·å–æœ€è¿‘ä¸Šä¼ çš„æ–‡ä»¶å¹¶æµ‹è¯•è®¿é—®</p>
            <button class="test-button" onclick="testLatestFile()">æµ‹è¯•æœ€æ–°æ–‡ä»¶</button>
            <div id="test1-result" class="result" style="display:none;"></div>
            <div id="test1-preview" class="image-preview" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>æ­¥éª¤ 2ï¼šæµ‹è¯•æ•°æ®åº“ä¸­çš„ä½œå“</h2>
            <p>ä» Creative Service è·å–ä½œå“æ•°æ®å¹¶æµ‹è¯•å›¾ç‰‡URL</p>
            <button class="test-button" onclick="testCreativeWorks()">æµ‹è¯•ä½œå“æ•°æ®</button>
            <div id="test2-result" class="result" style="display:none;"></div>
            <div id="test2-preview" class="image-preview" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>æ­¥éª¤ 3ï¼šæµ‹è¯•å‰ç«¯ä»£ç†</h2>
            <p>é€šè¿‡å‰ç«¯ä»£ç†è®¿é—®å›¾ç‰‡</p>
            <button class="test-button" onclick="testFrontendProxy()">æµ‹è¯•å‰ç«¯ä»£ç†</button>
            <div id="test3-result" class="result" style="display:none;"></div>
            <div id="test3-preview" class="image-preview" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>æ­¥éª¤ 4ï¼šå®Œæ•´æµç¨‹æµ‹è¯•</h2>
            <p>æ¨¡æ‹Ÿå‰ç«¯å®Œæ•´çš„å›¾ç‰‡åŠ è½½æµç¨‹</p>
            <button class="test-button" onclick="testCompleteFlow()">å®Œæ•´æµç¨‹æµ‹è¯•</button>
            <div id="test4-result" class="result" style="display:none;"></div>
            <div id="test4-preview" class="image-preview" style="display:none;"></div>
        </div>

        <div class="section">
            <h2>ğŸ”§ ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•</h2>
            <button class="test-button" onclick="runAllTests()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function clearLog(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            element.style.display = 'none';
        }

        async function testLatestFile() {
            const resultId = 'test1-result';
            const previewId = 'test1-preview';
            clearLog(resultId);
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).innerHTML = '';

            log(resultId, 'ğŸ” æ­¥éª¤ 1ï¼šæµ‹è¯•æœ€æ–°ä¸Šä¼ çš„æ–‡ä»¶...', 'info');

            // æµ‹è¯•æœ€æ–°çš„æ–‡ä»¶ï¼ˆæ ¹æ®ä½ çš„è¾“å‡ºï¼‰
            const testUrls = [
                'http://localhost:8083/uploads/images/2026/01/04/e3e82394-7ed6-4d23-9840-42d9d32f35f3.png',
                'http://localhost:8083/uploads/images/2026/01/04/f8676b11-3c78-419e-bcc3-f6cc63dee774.png',
                'http://localhost:8083/uploads/images/2026/01/04/3ad68ab2-dbd1-459d-9b73-0450e3d5584c.png'
            ];

            for (const url of testUrls) {
                log(resultId, `æµ‹è¯•URL: ${url}`, 'info');
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        const blob = await response.blob();
                        log(resultId, `âœ… æˆåŠŸï¼çŠ¶æ€ç : ${response.status}, å¤§å°: ${blob.size} bytes`, 'success');
                        
                        // æ˜¾ç¤ºå›¾ç‰‡
                        const imgUrl = URL.createObjectURL(blob);
                        const preview = document.getElementById(previewId);
                        preview.innerHTML += `<img src="${imgUrl}" alt="æµ‹è¯•å›¾ç‰‡" style="margin: 10px;">`;
                        preview.style.display = 'block';
                        break; // æˆåŠŸä¸€ä¸ªå°±å¤Ÿäº†
                    } else {
                        log(resultId, `âŒ å¤±è´¥ï¼çŠ¶æ€ç : ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(resultId, `âŒ é”™è¯¯: ${error.message}`, 'error');
                }
            }
        }

        async function testCreativeWorks() {
            const resultId = 'test2-result';
            const previewId = 'test2-preview';
            clearLog(resultId);
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).innerHTML = '';

            log(resultId, 'ğŸ” æ­¥éª¤ 2ï¼šä» Creative Service è·å–ä½œå“æ•°æ®...', 'info');

            try {
                const response = await fetch('http://localhost:8087/api/creative/designs?page=1&size=10');
                log(resultId, `çŠ¶æ€ç : ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log(resultId, `âœ… è·å–æˆåŠŸ`, 'success');
                    log(resultId, `å“åº”æ•°æ®: ${JSON.stringify(data).substring(0, 200)}...`, 'info');

                    // è§£æä½œå“æ•°æ®
                    let works = [];
                    if (data.code === 200 && data.data) {
                        works = Array.isArray(data.data) ? data.data : data.data.records || [];
                    } else if (Array.isArray(data)) {
                        works = data;
                    }

                    log(resultId, `ä½œå“æ•°é‡: ${works.length}`, 'info');

                    if (works.length > 0) {
                        const latestWork = works[0];
                        log(resultId, `æœ€æ–°ä½œå“: ${latestWork.title}`, 'info');
                        log(resultId, `å°é¢å›¾ç‰‡: ${latestWork.coverImage}`, 'info');
                        log(resultId, `æ–‡ä»¶åˆ—è¡¨: ${latestWork.files}`, 'info');

                        // æµ‹è¯•å°é¢å›¾ç‰‡
                        if (latestWork.coverImage) {
                            log(resultId, `æµ‹è¯•å°é¢å›¾ç‰‡...`, 'info');
                            try {
                                const imgResponse = await fetch(latestWork.coverImage);
                                if (imgResponse.ok) {
                                    const blob = await imgResponse.blob();
                                    log(resultId, `âœ… å°é¢å›¾ç‰‡åŠ è½½æˆåŠŸï¼å¤§å°: ${blob.size} bytes`, 'success');
                                    
                                    const imgUrl = URL.createObjectURL(blob);
                                    const preview = document.getElementById(previewId);
                                    preview.innerHTML = `<h3>å°é¢å›¾ç‰‡</h3><img src="${imgUrl}" alt="å°é¢">`;
                                    preview.style.display = 'block';
                                } else {
                                    log(resultId, `âŒ å°é¢å›¾ç‰‡åŠ è½½å¤±è´¥: ${imgResponse.status}`, 'error');
                                }
                            } catch (error) {
                                log(resultId, `âŒ å°é¢å›¾ç‰‡åŠ è½½é”™è¯¯: ${error.message}`, 'error');
                            }
                        }
                    }
                } else {
                    log(resultId, `âŒ è·å–ä½œå“å¤±è´¥`, 'error');
                }
            } catch (error) {
                log(resultId, `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testFrontendProxy() {
            const resultId = 'test3-result';
            const previewId = 'test3-preview';
            clearLog(resultId);
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).innerHTML = '';

            log(resultId, 'ğŸ” æ­¥éª¤ 3ï¼šæµ‹è¯•å‰ç«¯ä»£ç†...', 'info');
            log(resultId, 'æ³¨æ„ï¼šæ­¤æµ‹è¯•éœ€è¦å‰ç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:3002', 'warning');

            const proxyUrl = '/uploads/images/2026/01/04/e3e82394-7ed6-4d23-9840-42d9d32f35f3.png';
            log(resultId, `ä»£ç†URL: ${proxyUrl}`, 'info');

            try {
                const response = await fetch(proxyUrl);
                log(resultId, `çŠ¶æ€ç : ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const blob = await response.blob();
                    log(resultId, `âœ… ä»£ç†è®¿é—®æˆåŠŸï¼å¤§å°: ${blob.size} bytes`, 'success');
                    
                    const imgUrl = URL.createObjectURL(blob);
                    const preview = document.getElementById(previewId);
                    preview.innerHTML = `<img src="${imgUrl}" alt="ä»£ç†å›¾ç‰‡">`;
                    preview.style.display = 'block';
                } else {
                    log(resultId, `âŒ ä»£ç†è®¿é—®å¤±è´¥`, 'error');
                    log(resultId, `å¯èƒ½åŸå› ï¼šå‰ç«¯æœåŠ¡æœªè¿è¡Œæˆ–ä»£ç†é…ç½®é”™è¯¯`, 'warning');
                }
            } catch (error) {
                log(resultId, `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testCompleteFlow() {
            const resultId = 'test4-result';
            const previewId = 'test4-preview';
            clearLog(resultId);
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).innerHTML = '';

            log(resultId, 'ğŸ” æ­¥éª¤ 4ï¼šå®Œæ•´æµç¨‹æµ‹è¯•...', 'info');

            // 1. è·å–ä½œå“æ•°æ®
            log(resultId, '[1/3] è·å–ä½œå“æ•°æ®...', 'info');
            try {
                const response = await fetch('http://localhost:8087/api/creative/designs?page=1&size=10');
                if (!response.ok) {
                    log(resultId, `âŒ è·å–ä½œå“å¤±è´¥: ${response.status}`, 'error');
                    return;
                }

                const data = await response.json();
                let works = [];
                if (data.code === 200 && data.data) {
                    works = Array.isArray(data.data) ? data.data : data.data.records || [];
                } else if (Array.isArray(data)) {
                    works = data;
                }

                if (works.length === 0) {
                    log(resultId, `âŒ æ²¡æœ‰ä½œå“æ•°æ®`, 'error');
                    return;
                }

                log(resultId, `âœ… è·å–åˆ° ${works.length} ä¸ªä½œå“`, 'success');

                // 2. è§£æå›¾ç‰‡URL
                log(resultId, '[2/3] è§£æå›¾ç‰‡URL...', 'info');
                const work = works[0];
                log(resultId, `ä½œå“æ ‡é¢˜: ${work.title}`, 'info');
                
                let imageUrl = '';
                if (work.coverImage) {
                    imageUrl = work.coverImage;
                } else if (work.files) {
                    const filesArray = typeof work.files === 'string' 
                        ? work.files.split(',').map(f => f.trim())
                        : work.files;
                    imageUrl = filesArray[0] || '';
                }

                if (!imageUrl) {
                    log(resultId, `âŒ ä½œå“æ²¡æœ‰å›¾ç‰‡URL`, 'error');
                    return;
                }

                log(resultId, `å›¾ç‰‡URL: ${imageUrl}`, 'info');

                // 3. åŠ è½½å›¾ç‰‡
                log(resultId, '[3/3] åŠ è½½å›¾ç‰‡...', 'info');
                const img = new Image();
                img.crossOrigin = 'anonymous';

                img.onload = () => {
                    log(resultId, `âœ… å›¾ç‰‡åŠ è½½æˆåŠŸï¼å°ºå¯¸: ${img.width} x ${img.height}`, 'success');
                    const preview = document.getElementById(previewId);
                    preview.innerHTML = `<h3>${work.title}</h3><img src="${imageUrl}" alt="${work.title}">`;
                    preview.style.display = 'block';
                };

                img.onerror = (error) => {
                    log(resultId, `âŒ å›¾ç‰‡åŠ è½½å¤±è´¥`, 'error');
                    log(resultId, `é”™è¯¯: ${error}`, 'error');
                    log(resultId, `å¯èƒ½åŸå› ï¼š`, 'warning');
                    log(resultId, `1. URLæ ¼å¼ä¸æ­£ç¡®`, 'warning');
                    log(resultId, `2. æ–‡ä»¶ä¸å­˜åœ¨`, 'warning');
                    log(resultId, `3. CORSé…ç½®é—®é¢˜`, 'warning');
                    log(resultId, `4. é™æ€èµ„æºæ˜ å°„æœªé…ç½®`, 'warning');
                };

                img.src = imageUrl;

            } catch (error) {
                log(resultId, `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            console.log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            await testLatestFile();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testCreativeWorks();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testFrontendProxy();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testCompleteFlow();
            console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ');
        }
    </script>
</body>
</html>
