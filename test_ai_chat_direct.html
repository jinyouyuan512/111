<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>æµ‹è¯• n8n AI èŠå¤© - å†€å°æ¸¸</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    .test-box { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
    button { background: #52c41a; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; }
    button:hover { background: #389e0d; }
    button:disabled { background: #ccc; }
    input { width: 100%; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; margin: 10px 0; }
    pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; }
    .success { color: #52c41a; }
    .error { color: #ff4d4f; }
    .chat-msg { padding: 10px; margin: 5px 0; border-radius: 8px; }
    .user { background: #e6f7ff; text-align: right; }
    .assistant { background: #f6ffed; }
  </style>
</head>
<body>
  <h1>ğŸ¤– æµ‹è¯• n8n AI èŠå¤© - å†€å°æ¸¸</h1>
  
  <div class="test-box">
    <h3>1. ç›´æ¥æµ‹è¯• n8n Webhook (POST)</h3>
    <p>æµ‹è¯• URL: <code>http://localhost:5678/webhook/tourism/ai-chat</code></p>
    <input type="text" id="question" placeholder="è¾“å…¥é—®é¢˜ï¼Œå¦‚ï¼šè¥¿æŸå¡æœ‰ä»€ä¹ˆå¥½ç©çš„ï¼Ÿ" value="ä½ å¥½ï¼Œä»‹ç»ä¸€ä¸‹è¥¿æŸå¡">
    <button onclick="testN8nDirect()">ç›´æ¥è°ƒç”¨ n8n</button>
    <div id="result1"></div>
  </div>

  <div class="test-box">
    <h3>2. é€šè¿‡ Vite ä»£ç†æµ‹è¯•</h3>
    <p>æµ‹è¯• URL: <code>http://localhost:3001/webhook/tourism/ai-chat</code></p>
    <button onclick="testViaProxy()">é€šè¿‡ä»£ç†è°ƒç”¨</button>
    <div id="result2"></div>
  </div>

  <div class="test-box">
    <h3>3. èŠå¤©æµ‹è¯•</h3>
    <div id="chatBox" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 6px; margin-bottom: 10px;"></div>
    <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()">å‘é€</button>
  </div>

  <script>
    const N8N_DIRECT = 'http://localhost:5678/webhook/tourism/ai-chat';
    const N8N_PROXY = '/webhook/tourism/ai-chat';
    
    async function testN8nDirect() {
      const question = document.getElementById('question').value;
      const result = document.getElementById('result1');
      result.innerHTML = '<p>â³ æ­£åœ¨è°ƒç”¨ n8n...</p>';
      
      try {
        const response = await fetch(N8N_DIRECT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, sessionId: 'test-' + Date.now() })
        });
        
        const text = await response.text();
        console.log('Raw response:', text);
        
        if (!response.ok) {
          result.innerHTML = `<p class="error">âŒ HTTP ${response.status}</p><pre>${text}</pre>`;
          return;
        }
        
        if (!text) {
          result.innerHTML = `<p class="error">âŒ ç©ºå“åº” - å·¥ä½œæµå¯èƒ½æœªæ¿€æ´»æˆ–é…ç½®é”™è¯¯</p>`;
          return;
        }
        
        try {
          const data = JSON.parse(text);
          result.innerHTML = `<p class="success">âœ… æˆåŠŸ!</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
          
          if (data.answer) {
            result.innerHTML += `<div class="chat-msg assistant"><strong>å†€å°æ¸¸:</strong> ${data.answer}</div>`;
          }
        } catch (e) {
          result.innerHTML = `<p class="error">âŒ JSON è§£æå¤±è´¥</p><pre>${text}</pre>`;
        }
      } catch (e) {
        result.innerHTML = `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>
          <p>å¯èƒ½åŸå› :</p>
          <ul>
            <li>n8n æœªè¿è¡Œ (æ£€æŸ¥ http://localhost:5678)</li>
            <li>å·¥ä½œæµæœªæ¿€æ´»</li>
            <li>CORS é—®é¢˜ (éœ€è¦é€šè¿‡ä»£ç†è®¿é—®)</li>
          </ul>`;
      }
    }
    
    async function testViaProxy() {
      const question = document.getElementById('question').value;
      const result = document.getElementById('result2');
      result.innerHTML = '<p>â³ æ­£åœ¨é€šè¿‡ä»£ç†è°ƒç”¨...</p>';
      
      try {
        const response = await fetch(N8N_PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, sessionId: 'test-' + Date.now() })
        });
        
        const text = await response.text();
        console.log('Proxy response:', text);
        
        if (!response.ok) {
          result.innerHTML = `<p class="error">âŒ HTTP ${response.status}</p><pre>${text}</pre>`;
          return;
        }
        
        if (!text) {
          result.innerHTML = `<p class="error">âŒ ç©ºå“åº”</p>`;
          return;
        }
        
        try {
          const data = JSON.parse(text);
          result.innerHTML = `<p class="success">âœ… æˆåŠŸ!</p><pre>${JSON.stringify(data, null, 2)}</pre>`;
        } catch (e) {
          result.innerHTML = `<p class="error">âŒ JSON è§£æå¤±è´¥</p><pre>${text}</pre>`;
        }
      } catch (e) {
        result.innerHTML = `<p class="error">âŒ è¯·æ±‚å¤±è´¥: ${e.message}</p>`;
      }
    }
    
    async function sendChat() {
      const input = document.getElementById('chatInput');
      const chatBox = document.getElementById('chatBox');
      const question = input.value.trim();
      if (!question) return;
      
      chatBox.innerHTML += `<div class="chat-msg user"><strong>ä½ :</strong> ${question}</div>`;
      input.value = '';
      
      try {
        const response = await fetch(N8N_PROXY, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, sessionId: 'chat-session' })
        });
        
        const text = await response.text();
        if (text) {
          const data = JSON.parse(text);
          const answer = data.answer || data.message || data.text || '(æ— å›å¤)';
          chatBox.innerHTML += `<div class="chat-msg assistant"><strong>ğŸ¤– å†€å°æ¸¸:</strong> ${answer.replace(/\n/g, '<br>')}</div>`;
        } else {
          chatBox.innerHTML += `<div class="chat-msg assistant error"><strong>ğŸ¤–:</strong> (ç©ºå“åº” - æ£€æŸ¥ n8n å·¥ä½œæµ)</div>`;
        }
      } catch (e) {
        chatBox.innerHTML += `<div class="chat-msg assistant error"><strong>é”™è¯¯:</strong> ${e.message}</div>`;
      }
      
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
