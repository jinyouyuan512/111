<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯• - å›¾ç‰‡åŠ è½½è¯Šæ–­</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .test-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }
        .test-section h2 {
            color: #667eea;
            margin-top: 0;
            font-size: 1.3rem;
        }
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .result {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .image-preview {
            margin-top: 15px;
            text-align: center;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #856404;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æµè§ˆå™¨æ§åˆ¶å°æµ‹è¯•</h1>
        <p class="subtitle">è¯Šæ–­ä½œå“è¯¦æƒ…å¼¹çª—å›¾ç‰‡ä¸æ˜¾ç¤ºé—®é¢˜</p>

        <div class="instructions">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <ol>
                <li>ç¡®ä¿å‰ç«¯æœåŠ¡è¿è¡Œåœ¨ <code>http://localhost:3001</code></li>
                <li>ç¡®ä¿åç«¯ Social Service è¿è¡Œåœ¨ <code>http://localhost:8083</code></li>
                <li>æŒ‰ <code>F12</code> æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·</li>
                <li>ç‚¹å‡»ä¸‹é¢çš„æµ‹è¯•æŒ‰é’®ï¼ŒæŸ¥çœ‹ç»“æœ</li>
                <li>å¦‚æœæµ‹è¯•å¤±è´¥ï¼ŒæŸ¥çœ‹æ§åˆ¶å°çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯</li>
            </ol>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 1ï¼šæ£€æŸ¥å‰ç«¯æœåŠ¡</h2>
            <p>æµ‹è¯•å‰ç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ</p>
            <button class="test-button" onclick="testFrontend()">è¿è¡Œæµ‹è¯•</button>
            <div id="test1-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 2ï¼šç›´æ¥è®¿é—®åç«¯å›¾ç‰‡</h2>
            <p>ç›´æ¥è®¿é—®åç«¯æœåŠ¡çš„å›¾ç‰‡URLï¼ˆç»•è¿‡ä»£ç†ï¼‰</p>
            <button class="test-button" onclick="testBackendDirect()">è¿è¡Œæµ‹è¯•</button>
            <div id="test2-result" class="result" style="display:none;"></div>
            <div id="test2-preview" class="image-preview" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 3ï¼šé€šè¿‡ä»£ç†è®¿é—®å›¾ç‰‡</h2>
            <p>é€šè¿‡ Vite ä»£ç†è®¿é—®å›¾ç‰‡ï¼ˆæ¨¡æ‹Ÿå‰ç«¯é¡µé¢çš„è¯·æ±‚ï¼‰</p>
            <button class="test-button" onclick="testProxy()">è¿è¡Œæµ‹è¯•</button>
            <div id="test3-result" class="result" style="display:none;"></div>
            <div id="test3-preview" class="image-preview" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 4ï¼šæ£€æŸ¥ CORS é…ç½®</h2>
            <p>æµ‹è¯•è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰é…ç½®æ˜¯å¦æ­£ç¡®</p>
            <button class="test-button" onclick="testCORS()">è¿è¡Œæµ‹è¯•</button>
            <div id="test4-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 5ï¼šæ¨¡æ‹Ÿå‰ç«¯è¯·æ±‚</h2>
            <p>å®Œå…¨æ¨¡æ‹Ÿå‰ç«¯é¡µé¢çš„å›¾ç‰‡åŠ è½½è¿‡ç¨‹</p>
            <button class="test-button" onclick="testFrontendSimulation()">è¿è¡Œæµ‹è¯•</button>
            <div id="test5-result" class="result" style="display:none;"></div>
            <div id="test5-preview" class="image-preview" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯• 6ï¼šæ£€æŸ¥æµè§ˆå™¨ç¼“å­˜</h2>
            <p>æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦ä½¿ç”¨äº†ç¼“å­˜çš„æ—§èµ„æº</p>
            <button class="test-button" onclick="testCache()">è¿è¡Œæµ‹è¯•</button>
            <div id="test6-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•</h2>
            <button class="test-button" onclick="runAllTests()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        </div>
    </div>

    <script>
        const imageUrl = 'http://localhost:8083/uploads/images/2026/01/04/36b56a91-ba57-403d-acd5-6d6d6805e41c.png';
        const proxyUrl = '/uploads/images/2026/01/04/36b56a91-ba57-403d-acd5-6d6d6805e41c.png';

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">${message}</div>`;
        }

        function clearLog(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = '';
            element.style.display = 'none';
        }

        async function testFrontend() {
            const resultId = 'test1-result';
            clearLog(resultId);
            log(resultId, 'ğŸ” æµ‹è¯• 1ï¼šæ£€æŸ¥å‰ç«¯æœåŠ¡...', 'info');

            try {
                const response = await fetch('http://localhost:3001');
                if (response.ok) {
                    log(resultId, 'âœ… å‰ç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ', 'success');
                    log(resultId, `çŠ¶æ€ç : ${response.status}`, 'info');
                } else {
                    log(resultId, `âŒ å‰ç«¯æœåŠ¡å“åº”å¼‚å¸¸: ${response.status}`, 'error');
                }
            } catch (error) {
                log(resultId, `âŒ æ— æ³•è¿æ¥åˆ°å‰ç«¯æœåŠ¡: ${error.message}`, 'error');
                log(resultId, 'è¯·ç¡®ä¿å‰ç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:3001', 'warning');
            }
        }

        async function testBackendDirect() {
            const resultId = 'test2-result';
            const previewId = 'test2-preview';
            clearLog(resultId);
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).innerHTML = '';

            log(resultId, 'ğŸ” æµ‹è¯• 2ï¼šç›´æ¥è®¿é—®åç«¯å›¾ç‰‡...', 'info');
            log(resultId, `URL: ${imageUrl}`, 'info');

            try {
                const response = await fetch(imageUrl, { mode: 'cors' });
                log(resultId, `çŠ¶æ€ç : ${response.status}`, response.ok ? 'success' : 'error');
                log(resultId, `Content-Type: ${response.headers.get('content-type')}`, 'info');

                if (response.ok) {
                    const blob = await response.blob();
                    log(resultId, `æ–‡ä»¶å¤§å°: ${blob.size} bytes`, 'info');
                    log(resultId, 'âœ… åç«¯å›¾ç‰‡è®¿é—®æˆåŠŸ', 'success');

                    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                    const imgUrl = URL.createObjectURL(blob);
                    const preview = document.getElementById(previewId);
                    preview.innerHTML = `<img src="${imgUrl}" alt="å›¾ç‰‡é¢„è§ˆ">`;
                    preview.style.display = 'block';
                } else {
                    log(resultId, `âŒ åç«¯å›¾ç‰‡è®¿é—®å¤±è´¥: ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(resultId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                if (error.message.includes('CORS')) {
                    log(resultId, 'âš ï¸ CORS é”™è¯¯ï¼šåç«¯æœªæ­£ç¡®é…ç½®è·¨åŸŸè®¿é—®', 'warning');
                }
            }
        }

        async function testProxy() {
            const resultId = 'test3-result';
            const previewId = 'test3-preview';
            clearLog(resultId);
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).innerHTML = '';

            log(resultId, 'ğŸ” æµ‹è¯• 3ï¼šé€šè¿‡ä»£ç†è®¿é—®å›¾ç‰‡...', 'info');
            log(resultId, `ä»£ç†URL: ${proxyUrl}`, 'info');

            try {
                const response = await fetch(proxyUrl);
                log(resultId, `çŠ¶æ€ç : ${response.status}`, response.ok ? 'success' : 'error');
                log(resultId, `Content-Type: ${response.headers.get('content-type')}`, 'info');

                if (response.ok) {
                    const blob = await response.blob();
                    log(resultId, `æ–‡ä»¶å¤§å°: ${blob.size} bytes`, 'info');
                    log(resultId, 'âœ… ä»£ç†è®¿é—®æˆåŠŸ', 'success');

                    // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                    const imgUrl = URL.createObjectURL(blob);
                    const preview = document.getElementById(previewId);
                    preview.innerHTML = `<img src="${imgUrl}" alt="å›¾ç‰‡é¢„è§ˆ">`;
                    preview.style.display = 'block';
                } else {
                    log(resultId, `âŒ ä»£ç†è®¿é—®å¤±è´¥: ${response.statusText}`, 'error');
                    log(resultId, 'âš ï¸ è¯·æ£€æŸ¥ Vite ä»£ç†é…ç½®', 'warning');
                }
            } catch (error) {
                log(resultId, `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                log(resultId, 'âš ï¸ å¯èƒ½çš„åŸå› ï¼š', 'warning');
                log(resultId, '1. å‰ç«¯æœåŠ¡æœªè¿è¡Œ', 'warning');
                log(resultId, '2. Vite ä»£ç†é…ç½®é”™è¯¯', 'warning');
                log(resultId, '3. åç«¯æœåŠ¡æœªè¿è¡Œ', 'warning');
            }
        }

        async function testCORS() {
            const resultId = 'test4-result';
            clearLog(resultId);
            log(resultId, 'ğŸ” æµ‹è¯• 4ï¼šæ£€æŸ¥ CORS é…ç½®...', 'info');

            try {
                const response = await fetch(imageUrl, {
                    method: 'HEAD',
                    mode: 'cors'
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('access-control-allow-origin'),
                    'Access-Control-Allow-Methods': response.headers.get('access-control-allow-methods'),
                    'Access-Control-Allow-Headers': response.headers.get('access-control-allow-headers')
                };

                log(resultId, 'CORS å“åº”å¤´:', 'info');
                for (const [key, value] of Object.entries(corsHeaders)) {
                    if (value) {
                        log(resultId, `  ${key}: ${value}`, 'success');
                    } else {
                        log(resultId, `  ${key}: (æœªè®¾ç½®)`, 'warning');
                    }
                }

                if (corsHeaders['Access-Control-Allow-Origin']) {
                    log(resultId, 'âœ… CORS é…ç½®æ­£å¸¸', 'success');
                } else {
                    log(resultId, 'âš ï¸ CORS é…ç½®å¯èƒ½æœ‰é—®é¢˜', 'warning');
                }
            } catch (error) {
                log(resultId, `âŒ CORS æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testFrontendSimulation() {
            const resultId = 'test5-result';
            const previewId = 'test5-preview';
            clearLog(resultId);
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).innerHTML = '';

            log(resultId, 'ğŸ” æµ‹è¯• 5ï¼šæ¨¡æ‹Ÿå‰ç«¯è¯·æ±‚...', 'info');

            // æ¨¡æ‹Ÿå‰ç«¯çš„ getMediaUrl å‡½æ•°
            const work = {
                coverImage: 'http://localhost:8083/uploads/images/2026/01/04/36b56a91-ba57-403d-acd5-6d6d6805e41c.png',
                files: ['http://localhost:8083/uploads/images/2026/01/04/36b56a91-ba57-403d-acd5-6d6d6805e41c.png']
            };

            const mediaUrl = work.coverImage || (work.files && work.files.length > 0 ? work.files[0] : '');
            log(resultId, `è®¡ç®—å‡ºçš„å›¾ç‰‡URL: ${mediaUrl}`, 'info');

            if (!mediaUrl) {
                log(resultId, 'âŒ æ— æ³•è·å–å›¾ç‰‡URL', 'error');
                return;
            }

            // åˆ›å»º img å…ƒç´ æµ‹è¯•
            const img = new Image();
            img.crossOrigin = 'anonymous';

            img.onload = () => {
                log(resultId, 'âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
                log(resultId, `å›¾ç‰‡å°ºå¯¸: ${img.width} x ${img.height}`, 'info');

                const preview = document.getElementById(previewId);
                preview.innerHTML = `<img src="${mediaUrl}" alt="å›¾ç‰‡é¢„è§ˆ">`;
                preview.style.display = 'block';
            };

            img.onerror = (error) => {
                log(resultId, 'âŒ å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                log(resultId, `é”™è¯¯: ${error}`, 'error');
            };

            img.src = mediaUrl;
            log(resultId, 'æ­£åœ¨åŠ è½½å›¾ç‰‡...', 'info');
        }

        async function testCache() {
            const resultId = 'test6-result';
            clearLog(resultId);
            log(resultId, 'ğŸ” æµ‹è¯• 6ï¼šæ£€æŸ¥æµè§ˆå™¨ç¼“å­˜...', 'info');

            // æµ‹è¯•å¸¦ç¼“å­˜çš„è¯·æ±‚
            try {
                const cachedResponse = await fetch(imageUrl);
                const cacheControl = cachedResponse.headers.get('cache-control');
                const etag = cachedResponse.headers.get('etag');
                const lastModified = cachedResponse.headers.get('last-modified');

                log(resultId, 'ç¼“å­˜ç›¸å…³å“åº”å¤´:', 'info');
                log(resultId, `  Cache-Control: ${cacheControl || '(æœªè®¾ç½®)'}`, cacheControl ? 'info' : 'warning');
                log(resultId, `  ETag: ${etag || '(æœªè®¾ç½®)'}`, etag ? 'info' : 'warning');
                log(resultId, `  Last-Modified: ${lastModified || '(æœªè®¾ç½®)'}`, lastModified ? 'info' : 'warning');

                // æµ‹è¯•ä¸å¸¦ç¼“å­˜çš„è¯·æ±‚
                const noCacheResponse = await fetch(imageUrl, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });

                if (cachedResponse.ok && noCacheResponse.ok) {
                    log(resultId, 'âœ… ç¼“å­˜æµ‹è¯•é€šè¿‡', 'success');
                    log(resultId, 'å»ºè®®ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜åé‡è¯•', 'info');
                } else {
                    log(resultId, 'âš ï¸ ç¼“å­˜æµ‹è¯•å¼‚å¸¸', 'warning');
                }
            } catch (error) {
                log(resultId, `âŒ ç¼“å­˜æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function runAllTests() {
            console.log('ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            await testFrontend();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testBackendDirect();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testProxy();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCORS();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testFrontendSimulation();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testCache();
            console.log('âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ');
        }
    </script>
</body>
</html>
